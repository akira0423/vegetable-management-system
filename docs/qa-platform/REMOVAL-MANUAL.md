Q&A ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  åˆ‡ã‚Šé›¢ã—ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
ğŸ“‹ ã¯ã˜ã‚ã«

ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ã€Q&A ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æ—¢å­˜ã®é‡èœç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å®‰å…¨ã«åˆ‡ã‚Šé›¢ã—ã€å…ƒã®çŠ¶æ…‹ã«æˆ»ã™ãŸã‚ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

æ‰€è¦æ™‚é–“ï¼šç´„ 15 åˆ†
ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ï¼šä½ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å½±éŸ¿ãªã—ï¼‰

ã€æ›´æ–°ã€‘æœ¬ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ä»¥ä¸‹ã®åˆ†é…ãƒ«ãƒ¼ãƒ«ã«æ•´åˆã—ã¦ã„ã¾ã™ï¼š
ãƒ»ã‚¨ã‚¹ã‚¯ãƒ­ãƒ¼ï¼ˆæ‡¸è³é‡‘ï¼‰æ‰‹æ•°æ–™ï¼é‹å–¶ 20%ã€å›ç­”è€…å—å–ï¼ 80%
ãƒ»PPVï¼ˆç¬¬ä¸‰è€…é–²è¦§ï¼‰ï¼é‹å–¶ 20%ã€æ®‹ 80%ã‚’ è³ªå•è€… 40% / ãƒ™ã‚¹ãƒˆ 24% / ãã®ä»– 16%ï¼ˆå‡ç­‰å‰²ï¼‰
ãƒ»ãƒ™ã‚¹ãƒˆæœªç¢ºå®šæœŸé–“ä¸­ã® PPV ã¯ã€Œãƒ™ã‚¹ãƒˆ 24%åˆ†ï¼ held_for_bestã€ã¨ã—ã¦ä¿ç•™ã€ã€Œãã®ä»– 16%åˆ†ï¼ others ãƒ—ãƒ¼ãƒ«ã€ã‚’å‡ç­‰å‰²ã‚Šé…åˆ†
ãƒ»è³ªå•æœ¬æ–‡ã¯å…¨å“¡ã«å…¬é–‹ã€å›ç­”æœ¬æ–‡ã¯æ¨©é™åˆ¶å¾¡ï¼ˆASKER/RESPONDER/PPV/ADMINï¼‰
ãƒ»å›ç­”å“è³ªè¦ä»¶æ©Ÿèƒ½ï¼ˆæœ€å°æ–‡å­—æ•°ã€å†™çœŸ/å‹•ç”»å¿…é ˆè¨­å®šï¼‰

âš ï¸ åˆ‡ã‚Šé›¢ã—å‰ã®ç¢ºèªäº‹é …
å¿…é ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ®‹é«˜ã‚’ç¢ºèª

é€²è¡Œä¸­ã®è³ªå•ï¼ˆANSWERING/SELECTING/FUNDED çŠ¶æ…‹ï¼‰ã®æœ‰ç„¡ã‚’ç¢ºèªã€ä¿®æ­£ã€‘

æœªå‡¦ç†ã®å‡ºé‡‘ç”³è«‹ã®æœ‰ç„¡ã‚’ç¢ºèª

ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æº–å‚™å®Œäº†

ç®¡ç†è€…æ¨©é™ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª

ã€æ–°è¦ã€‘PPV ãƒ—ãƒ¼ãƒ«æ®‹é«˜ï¼ˆheld_for_best=ãƒ™ã‚¹ãƒˆ 24%ã€others=16%ï¼‰ã®ç¢ºèª

ğŸš¨ ç·Šæ€¥åœæ­¢ï¼ˆ1 åˆ†ï¼‰

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã€ã¾ãšä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

# 1. Q&A æ©Ÿèƒ½ã‚’å³åº§ã«ç„¡åŠ¹åŒ–

echo "QA_ENABLE_PLATFORM=false" >> .env.local

# 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•

npm run dev

# ã¾ãŸã¯æœ¬ç•ªç’°å¢ƒã®å ´åˆ

pm2 restart all

ã“ã‚Œã ã‘ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ Q&A æ©Ÿèƒ½ãŒè¦‹ãˆãªããªã‚Šã¾ã™ã€‚

ã€æ–°è¦ã€‘Stripe Webhook ãŒæ®‹å­˜ã—ã¦ã„ã‚‹å ´åˆã¯ä¸€æ™‚çš„ã« 410 ã‚’è¿”ã™ã‚ˆã†ãƒ«ãƒ¼ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆ/api/webhooks/stripeï¼‰ã€‚

ğŸ“ æ®µéšçš„åˆ‡ã‚Šé›¢ã—æ‰‹é †
Step 1: äº‹å‰æº–å‚™ï¼ˆ5 åˆ†ï¼‰
1-1. ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
-- Supabase SQL ã‚¨ãƒ‡ã‚£ã‚¿ã§å®Ÿè¡Œ
-- ç¾åœ¨ã® Q&A ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆã‚’å–å¾—
SELECT 'questions' AS table_name, COUNT(_) AS count FROM qa_questions
UNION ALL SELECT 'answers', COUNT(_) FROM qa_answers
UNION ALL SELECT 'profiles', COUNT(_) FROM qa_user_profiles
UNION ALL SELECT 'wallet_balance', COALESCE(SUM(balance_available),0) FROM qa_wallets
UNION ALL SELECT 'ppv_pool_questions', COUNT(_) FROM qa_ppv_pools; --ã€æ–°è¦ã€‘

1-2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå–å¼•ã®ç¢ºèª
-- é€²è¡Œä¸­ã®è³ªå•ã‚’ç¢ºèªï¼ˆFUNDED/ANSWERING/SELECTING ã‚’å¯¾è±¡ï¼‰ã€ä¿®æ­£ã€‘
SELECT id, title, status, bounty_amount, deadline_at
FROM qa_questions
WHERE status IN ('FUNDED','ANSWERING','SELECTING');

-- ä¿ç•™ä¸­ã®å‡ºé‡‘ã‚’ç¢ºèª
SELECT id, user_id, amount, status
FROM qa_payouts
WHERE status IN ('REQUESTED','PROCESSING');

1-3. PPV ãƒ—ãƒ¼ãƒ«æ®‹é«˜ã®ç¢ºèªã€æ–°è¦ã€‘
-- ãƒ™ã‚¹ãƒˆæœªç¢ºå®šä¿ç•™ï¼ˆheld_for_best ï¼ãƒ™ã‚¹ãƒˆ 24%ï¼‰ã¨ others16% ã®æ®‹é«˜
SELECT question_id, held_for_best, total_amount AS others_pool, updated_at
FROM qa_ppv_pools
ORDER BY updated_at DESC;

ã€æ–°è¦ã€‘é‹ç”¨æ–¹é‡ï¼šåˆ‡ã‚Šé›¢ã—ç›´å‰ã«ãƒ™ã‚¹ãƒˆãŒç¢ºå®šã—ã¦ã„ã‚‹è³ªå•ã¯
ãƒ»ãƒ™ã‚¹ãƒˆ 24%åˆ†ï¼šå³æ™‚æ¸…ç®—ï¼ˆbest ã¸ï¼‰
ãƒ»others16%åˆ†ï¼šãƒ—ãƒ¼ãƒ«ãƒ¡ãƒ³ãƒãƒ¼å‡ç­‰å‰²ï¼ˆãƒ–ãƒ­ãƒƒã‚¯é™¤å¤–æ¸ˆï¼‰
ãƒ™ã‚¹ãƒˆæœªç¢ºå®šã®è³ªå•ã¯ held_for_best/others ã‚’ã€Œæœªç²¾ç®—æ®‹ã€ãƒ¬ãƒãƒ¼ãƒˆã«å‡ºåŠ›ã€‚

Step 2: æ©Ÿèƒ½ã®ç„¡åŠ¹åŒ–ï¼ˆ2 åˆ†ï¼‰
2-1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

.env.local ã‚’ç·¨é›†:

# Q&A ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š

QA_ENABLE_PLATFORM=false # true ã‹ã‚‰ false ã«å¤‰æ›´

# QA_STRIPE_SECRET_KEY=sk_test_xxx # ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆä»»æ„ï¼‰

# QA_STRIPE_WEBHOOK_SECRET=whsec_xxx # ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆä»»æ„ï¼‰

# QA_STRIPE_CONNECT_CLIENT_ID=ca_xxx # ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆä»»æ„ï¼‰ã€æ–°è¦ã€‘

.env.production ã‚’ç·¨é›†ï¼ˆæœ¬ç•ªç’°å¢ƒã®å ´åˆï¼‰:

QA_ENABLE_PLATFORM=false

2-2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•

# é–‹ç™ºç’°å¢ƒ

npm run dev ã‚’å†èµ·å‹•ï¼ˆCtrl+C ã—ã¦å†åº¦å®Ÿè¡Œï¼‰

# æœ¬ç•ªç’°å¢ƒï¼ˆPM2 ä½¿ç”¨ã®å ´åˆï¼‰

pm2 restart your-app-name

# æœ¬ç•ªç’°å¢ƒï¼ˆsystemd ä½¿ç”¨ã®å ´åˆï¼‰

sudo systemctl restart your-app-service

# Vercel ã®å ´åˆ

vercel --prod

ã€æ–°è¦ã€‘Webhook ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½µè¨­ã—ã¦ã„ã‚‹å ´åˆã¯ /api/webhooks/stripe ã‚’åŒæ™‚ã«åœæ­¢/ç„¡åŠ¹åŒ–ã€‚

Step 3: ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ5 åˆ†ï¼‰
3-1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼ˆå®Œå…¨ç‰ˆï¼‰

ã€ä¿®æ­£ã€‘qa*purchases/qa_reputation ã¯å»ƒæ­¢ã€‚PPV ã¯ qa_transactions ã¨ qa_ppv*\* ã«çµ±åˆã€‚

-- Q&A ãƒ‡ãƒ¼ã‚¿å°‚ç”¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆ
CREATE SCHEMA IF NOT EXISTS qa_backup_20250922;

-- ã™ã¹ã¦ã® Q&A ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿…è¦ãªã‚‚ã®ã®ã¿ï¼‰
CREATE TABLE qa_backup_20250922.qa_questions AS SELECT _ FROM qa_questions;
CREATE TABLE qa_backup_20250922.qa_answers AS SELECT _ FROM qa_answers;
CREATE TABLE qa_backup_20250922.qa_user_profiles AS SELECT _ FROM qa_user_profiles;
CREATE TABLE qa_backup_20250922.qa_transactions AS SELECT _ FROM qa_transactions; --ã€æ–°è¦ã€‘
CREATE TABLE qa_backup_20250922.qa_wallets AS SELECT _ FROM qa_wallets;
CREATE TABLE qa_backup_20250922.qa_wallet_transactions AS SELECT _ FROM qa_wallet_transactions; --ã€æ–°è¦ã€‘
CREATE TABLE qa_backup_20250922.qa_access_grants AS SELECT _ FROM qa_access_grants;
CREATE TABLE qa_backup_20250922.qa_payouts AS SELECT _ FROM qa_payouts;
CREATE TABLE qa_backup_20250922.qa_invoices AS SELECT _ FROM qa_invoices;
CREATE TABLE qa_backup_20250922.qa_notifications AS SELECT _ FROM qa_notifications;
CREATE TABLE qa_backup_20250922.qa_audit_logs AS SELECT _ FROM qa_audit_logs;
CREATE TABLE qa_backup_20250922.qa_ppv_pools AS SELECT _ FROM qa_ppv_pools; --ã€æ–°è¦ã€‘
CREATE TABLE qa_backup_20250922.qa_ppv_pool_members AS SELECT _ FROM qa_ppv_pool_members; --ã€æ–°è¦ã€‘
CREATE TABLE qa_backup_20250922.qa_answer_blocks AS SELECT _ FROM qa_answer_blocks; --ã€æ–°è¦ã€‘

-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ã®ç¢ºèª
SELECT 'Backup completed at ' || NOW() AS status;

3-2. ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

# ã‚³ãƒ¼ãƒ‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

tar -czf qa-platform-backup-$(date +%Y%m%d).tar.gz \
 src/app/qa \
 src/components/qa \
 src/lib/qa \
 src/app/api/qa \
 src/app/api/webhooks/stripe \ #ã€æ–°è¦ã€‘Webhook ã‚‚é€€é¿
docs/qa-platform

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ãªå ´æ‰€ã«ç§»å‹•

mv qa-platform-backup-\*.tar.gz ~/backups/

Step 4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ3 åˆ†ï¼‰
4-1. ãƒˆãƒªã‚¬ãƒ¼ã¨é–¢æ•°ã®å‰Šé™¤
-- ãƒˆãƒªã‚¬ãƒ¼ã®å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
DROP TRIGGER IF EXISTS update_qa_user_profiles_updated_at ON qa_user_profiles;
DROP TRIGGER IF EXISTS update_qa_questions_updated_at ON qa_questions;
DROP TRIGGER IF EXISTS update_qa_answers_updated_at ON qa_answers;
DROP TRIGGER IF EXISTS update_qa_wallets_updated_at ON qa_wallets;
DROP TRIGGER IF EXISTS trg_ppv_pools_updated_at ON qa_ppv_pools; --ã€æ–°è¦ã€‘
DROP TRIGGER IF EXISTS grant_asker_access_on_question ON qa_questions; --ã€æ–°è¦ã€‘
DROP TRIGGER IF EXISTS grant_responder_access_on_answer ON qa_answers; --ã€æ–°è¦ã€‘
DROP TRIGGER IF EXISTS trg_enforce_answer_requirements ON qa_answers; --ã€å›ç­”å“è³ªå¼·åˆ¶ã€‘
DROP TRIGGER IF EXISTS trg_prevent_requirement_hardening ON qa_questions; --ã€è¦ä»¶å³æ ¼åŒ–é˜²æ­¢ã€‘

-- é–¢æ•°ã®å‰Šé™¤ï¼ˆåç§°ã‚’ã‚¹ã‚­ãƒ¼ãƒæœ€æ–°ç‰ˆã«æ•´åˆï¼‰ã€ä¿®æ­£/ç½®æ›ã€‘
DROP FUNCTION IF EXISTS update_updated_at_column();
DROP FUNCTION IF EXISTS generate_invoice_number(); --ï¼ˆæ—§ generate_invoice_no ã‚’ç½®æ›ï¼‰ã€ä¿®æ­£ã€‘
DROP FUNCTION IF EXISTS has_question_access(UUID, UUID); --ï¼ˆæ—§ check_question_access ã‚’ç½®æ›ï¼‰ã€ä¿®æ­£ã€‘
DROP FUNCTION IF EXISTS update_wallet_balance(UUID, DECIMAL, VARCHAR, VARCHAR, UUID, TEXT);
DROP FUNCTION IF EXISTS select_best_answer(UUID, UUID, TEXT); -- ã‚¨ã‚¹ã‚¯ãƒ­ãƒ¼ 20/80 æ¸…ç®—é–¢æ•°ã€æ–°è¦ã€‘
DROP FUNCTION IF EXISTS purchase_ppv_access(UUID, UUID, VARCHAR); -- PPV 20/40/24/16ã€æ–°è¦ã€‘
DROP FUNCTION IF EXISTS distribute_ppv_pool(UUID); -- others16%å‡ç­‰å‰²ã€æ–°è¦ã€‘
DROP FUNCTION IF EXISTS generate_monthly_invoices(); --ã€æ–°è¦ã€‘
DROP FUNCTION IF EXISTS migrate_cold_questions(); --ã€æ–°è¦ã€‘
DROP FUNCTION IF EXISTS record_event(VARCHAR, UUID, VARCHAR, JSONB); --ã€æ–°è¦ã€‘
DROP FUNCTION IF EXISTS qa_count_attachments(JSONB, TEXT); -- å›ç­”å“è³ªæ¤œè¨¼ç”¨ã€è¿½åŠ ã€‘
DROP FUNCTION IF EXISTS qa_enforce_answer_requirements(); -- å›ç­”è¦ä»¶å¼·åˆ¶ã€è¿½åŠ ã€‘
DROP FUNCTION IF EXISTS qa_prevent_requirement_hardening(); -- è¦ä»¶å³æ ¼åŒ–é˜²æ­¢ã€è¿½åŠ ã€‘

-- ãƒ“ãƒ¥ãƒ¼/ãƒãƒ†ãƒ“ãƒ¥ãƒ¼ã®å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰ã€ä¿®æ­£ã€‘
DROP MATERIALIZED VIEW IF EXISTS qa_stats_realtime;
DROP MATERIALIZED VIEW IF EXISTS qa_stats_ppv_daily;
DROP VIEW IF EXISTS qa_user_dashboard;
DROP VIEW IF EXISTS qa_questions_list;
DROP VIEW IF EXISTS qa_performance_metrics;

4-2. ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤
-- RLS ã‚’ç„¡åŠ¹åŒ–ï¼ˆqa\_ç³»ã™ã¹ã¦ï¼‰ã€ä¿®æ­£ã€‘
ALTER TABLE qa_questions DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_answers DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_user_profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_transactions DISABLE ROW LEVEL SECURITY; --ã€æ–°è¦ã€‘
ALTER TABLE qa_wallets DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_wallet_transactions DISABLE ROW LEVEL SECURITY; --ã€æ–°è¦ã€‘
ALTER TABLE qa_access_grants DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_payouts DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_invoices DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_notifications DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_audit_logs DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_ratings DISABLE ROW LEVEL SECURITY;
ALTER TABLE qa_ppv_pools DISABLE ROW LEVEL SECURITY; --ã€æ–°è¦ã€‘
ALTER TABLE qa_ppv_pool_members DISABLE ROW LEVEL SECURITY; --ã€æ–°è¦ã€‘
ALTER TABLE qa_answer_blocks DISABLE ROW LEVEL SECURITY; --ã€æ–°è¦ã€‘

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ï¼ˆä¾å­˜é–¢ä¿‚ã«æ³¨æ„ï¼‰ã€ä¿®æ­£ã€‘
DROP TABLE IF EXISTS qa_ppv_pool_members CASCADE; --ã€æ–°è¦ã€‘
DROP TABLE IF EXISTS qa_ppv_pools CASCADE; --ã€æ–°è¦ã€‘
DROP TABLE IF EXISTS qa_answer_blocks CASCADE; --ã€æ–°è¦ã€‘
DROP TABLE IF EXISTS qa_wallet_transactions CASCADE; --ã€æ–°è¦ã€‘
DROP TABLE IF EXISTS qa_transactions CASCADE; --ã€æ–°è¦ã€‘
DROP TABLE IF EXISTS qa_access_grants CASCADE;
DROP TABLE IF EXISTS qa_ratings CASCADE;
DROP TABLE IF EXISTS qa_notifications CASCADE;
DROP TABLE IF EXISTS qa_invoices CASCADE;
DROP TABLE IF EXISTS qa_payouts CASCADE;
DROP TABLE IF EXISTS qa_answers CASCADE;
DROP TABLE IF EXISTS qa_questions CASCADE;
DROP TABLE IF EXISTS qa_wallets CASCADE;
DROP TABLE IF EXISTS qa_user_profiles CASCADE;

-- åˆ—æŒ™å‹ã®å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰ã€ä¿®æ­£ã€‘
DROP TYPE IF EXISTS qa_question_status CASCADE;
DROP TYPE IF EXISTS qa_payment_type CASCADE;
DROP TYPE IF EXISTS qa_payment_status CASCADE;
DROP TYPE IF EXISTS qa_user_tier CASCADE; --ã€æ–°è¦ã€‘
DROP TYPE IF EXISTS qa_notification_type CASCADE; --ã€æ–°è¦ã€‘

-- ã€å‰Šé™¤ã€‘ä»¥ä¸‹ã®å‹ã¯ã‚¹ã‚­ãƒ¼ãƒå¤–ï¼šqa_answer_status / qa_payout_status / qa_access_reasonã€å‰Šé™¤ã€‘

Step 5: ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ï¼ˆ2 åˆ†ï¼‰
5-1. è‡ªå‹•å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ

remove-qa-platform.ps1 (Windows PowerShell):

# Q&A ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

Write-Host "Q&A ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™..." -ForegroundColor Yellow

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤

Remove-Item -Path "src\app\qa" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "src\components\qa" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "src\lib\qa" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "src\hooks\qa" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "src\app\api\qa" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path "src\app\api\webhooks\stripe" -Recurse -Force -ErrorAction SilentlyContinue #ã€æ–°è¦ã€‘
Remove-Item -Path "docs\qa-platform" -Recurse -Force -ErrorAction SilentlyContinue

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤

Get-ChildItem -Path "supabase\migrations" -Filter "_qa_" | Remove-Item -Force

Write-Host "ã‚³ãƒ¼ãƒ‰å‰Šé™¤å®Œäº†ï¼" -ForegroundColor Green

remove-qa-platform.sh (Mac/Linux):

#!/bin/bash

echo "Q&A ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™..."

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤

rm -rf src/app/qa
rm -rf src/components/qa
rm -rf src/lib/qa
rm -rf src/hooks/qa
rm -rf src/app/api/qa
rm -rf src/app/api/webhooks/stripe #ã€æ–°è¦ã€‘
rm -rf docs/qa-platform

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤

rm -f supabase/migrations/_qa_.sql

echo "ã‚³ãƒ¼ãƒ‰å‰Šé™¤å®Œäº†ï¼"

5-2. package.json ã®ç¢ºèªï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

Q&A å°‚ç”¨ã®ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ï¼š

# Stripe é–¢é€£ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã§æœªä½¿ç”¨ã®å ´åˆã®ã¿ï¼‰

npm uninstall stripe @stripe/stripe-js

Step 6: æœ€çµ‚ç¢ºèªï¼ˆ2 åˆ†ï¼‰
6-1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèª

# é–‹ç™ºç’°å¢ƒã§èµ·å‹•

npm run dev

# ä»¥ä¸‹ã‚’ç¢ºèªï¼š

# - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã« Q&A ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã“ã¨

# - /qa ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ï¼ˆ404ï¼‰

# - æ—¢å­˜æ©Ÿèƒ½ï¼ˆé‡èœç®¡ç†ã€ä½œæ¥­è¨˜éŒ²ç­‰ï¼‰ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨

# - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒãªã„ã“ã¨

6-2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèª
-- Q&A ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèª
SELECT table*name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name LIKE 'qa*%';
-- çµæœãŒ 0 ä»¶ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

ğŸ”„ å¾©å…ƒæ‰‹é †ï¼ˆå¿…è¦ãªå ´åˆï¼‰
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¾©å…ƒ
-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¾©å…ƒ
CREATE TABLE qa_questions AS SELECT _ FROM qa_backup_20250922.qa_questions;
CREATE TABLE qa_answers AS SELECT _ FROM qa_backup_20250922.qa_answers;
CREATE TABLE qa_user_profiles AS SELECT _ FROM qa_backup_20250922.qa_user_profiles;
CREATE TABLE qa_transactions AS SELECT _ FROM qa_backup_20250922.qa_transactions; --ã€æ–°è¦ã€‘
CREATE TABLE qa_wallets AS SELECT _ FROM qa_backup_20250922.qa_wallets;
CREATE TABLE qa_wallet_transactions AS SELECT _ FROM qa_backup_20250922.qa_wallet_transactions; --ã€æ–°è¦ã€‘
CREATE TABLE qa_access_grants AS SELECT _ FROM qa_backup_20250922.qa_access_grants;
CREATE TABLE qa_payouts AS SELECT _ FROM qa_backup_20250922.qa_payouts;
CREATE TABLE qa_invoices AS SELECT _ FROM qa_backup_20250922.qa_invoices;
CREATE TABLE qa_notifications AS SELECT _ FROM qa_backup_20250922.qa_notifications;
CREATE TABLE qa_audit_logs AS SELECT _ FROM qa_backup_20250922.qa_audit_logs;
CREATE TABLE qa_ppv_pools AS SELECT _ FROM qa_backup_20250922.qa_ppv_pools; --ã€æ–°è¦ã€‘
CREATE TABLE qa_ppv_pool_members AS SELECT _ FROM qa_backup_20250922.qa_ppv_pool_members; --ã€æ–°è¦ã€‘
CREATE TABLE qa_answer_blocks AS SELECT _ FROM qa_backup_20250922.qa_answer_blocks; --ã€æ–°è¦ã€‘

ã€æ–°è¦ã€‘å¾©å…ƒå¾Œã€å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®é–¢æ•°/ãƒˆãƒªã‚¬ãƒ¼ã‚’å†ä½œæˆï¼š
update_updated_at_column, grant_asker_access_on_question, grant_responder_access_on_answer,
select_best_answerï¼ˆ20/80ï¼‰ã€purchase_ppv_accessï¼ˆ20/40/24/16ï¼‰ã€distribute_ppv_poolã€generate_invoice_number ãªã©ã€‚

ã‚³ãƒ¼ãƒ‰ã®å¾©å…ƒ

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ

tar -xzf ~/backups/qa-platform-backup-20250922.tar.gz

# ç’°å¢ƒå¤‰æ•°ã‚’æœ‰åŠ¹åŒ–

# .env.local ã§ QA_ENABLE_PLATFORM=true ã«è¨­å®š

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•

npm run dev

ğŸ“Š åˆ‡ã‚Šé›¢ã—å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
å¿…é ˆç¢ºèªé …ç›®

Q&A ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„

/qa ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ï¼ˆ404 ã‚¨ãƒ©ãƒ¼ï¼‰

æ—¢å­˜æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œ

qa\_ ã§å§‹ã¾ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„

ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã—

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜æ¸ˆã¿

ã€æ–°è¦ã€‘Stripe Webhook ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèªé …ç›®

Stripe Connect ã®ç„¡åŠ¹åŒ–/åœæ­¢

é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

ãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥å®Œäº†

ã€æ–°è¦ã€‘PPV ãƒ—ãƒ¼ãƒ«æœªæ¸…ç®—æ®‹ã®ãƒ¬ãƒãƒ¼ãƒˆä¿ç®¡

ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
Q: å‰Šé™¤å¾Œã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢

rm -rf .next
npm run build
npm run dev

Q: ä¸€éƒ¨ã®æ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„
// src/config/features.ts ã‚’ç¢ºèª
export const FEATURES = {
QA_PLATFORM: false // å¿…ãš false ã«ãªã£ã¦ã„ã‚‹ã“ã¨
};

Q: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
ALTER TABLE <related_table>
DROP CONSTRAINT IF EXISTS <constraint_name>;

ğŸ“ ã‚µãƒãƒ¼ãƒˆé€£çµ¡å…ˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®é€£çµ¡å…ˆï¼š

æŠ€è¡“ã‚µãƒãƒ¼ãƒˆï¼š[ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹]

ç·Šæ€¥é€£çµ¡å…ˆï¼š[é›»è©±ç•ªå·]

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼š/docs/qa-platform/

ğŸ“… åˆ‡ã‚Šé›¢ã—å®Ÿæ–½è¨˜éŒ²
æ—¥æ™‚ å®Ÿæ–½è€… çµæœ å‚™è€ƒ
2025-09-22 10:00 - - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

é‡è¦ï¼š ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯å®šæœŸçš„ã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š 1.1.0ã€ä¿®æ­£ã€‘
æœ€çµ‚æ›´æ–°ï¼š 2025-09-22ã€ä¿®æ­£ã€‘
