# Q&Aãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  ãƒã‚¤ãƒ‘ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | é”æˆæ–¹æ³• |
|------|--------|---------|
| **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ** | 100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ | ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚° + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| **åŒæ™‚æ¥ç¶š** | 10ä¸‡ãƒ¦ãƒ¼ã‚¶ãƒ¼ | PgBouncer + Read Replica |
| **ãƒ¬ã‚¹ãƒãƒ³ã‚¹** | 99%tile < 100ms | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ + ãƒãƒ†ãƒ“ãƒ¥ãƒ¼ |
| **å¯ç”¨æ€§** | 99.99% | ãƒãƒ«ãƒAZ + è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ |
| **ãƒ‡ãƒ¼ã‚¿é‡** | 1å„„ãƒ¬ã‚³ãƒ¼ãƒ‰/å¹´ | è‡ªå‹•ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç®¡ç† |

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```mermaid
graph TB
    subgraph "CDN Layer"
        CF[CloudFlare CDN]
    end

    subgraph "Application Layer"
        LB[Load Balancer]
        API1[API Server 1]
        API2[API Server 2]
        API3[API Server N]
    end

    subgraph "Cache Layer"
        Redis1[Redis Primary]
        Redis2[Redis Replica]
        MC[Memcached]
    end

    subgraph "Connection Pool"
        PGB[PgBouncer]
    end

    subgraph "Database Layer"
        Master[(Primary DB)]
        Read1[(Read Replica 1)]
        Read2[(Read Replica 2)]
        Hot[(Hot Data DB)]
        Analytics[(Analytics DB)]
    end

    subgraph "Storage Layer"
        S3[Object Storage]
        Archive[Cold Archive]
    end

    CF --> LB
    LB --> API1 & API2 & API3
    API1 & API2 & API3 --> Redis1
    API1 & API2 & API3 --> PGB
    PGB --> Master
    PGB --> Read1 & Read2
    Redis1 --> Redis2
    Master --> Read1 & Read2
    Master --> Hot
    Master --> Analytics
    API1 & API2 & API3 --> S3
```

## ğŸ“Š ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

### 1. ãƒ‡ãƒ¼ã‚¿åˆ†å‰²æˆ¦ç•¥

#### æ™‚ç³»åˆ—ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°
```sql
-- æœˆæ¬¡ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆè‡ªå‹•ä½œæˆï¼‰
CREATE TABLE qa_questions_2025_09 PARTITION OF qa_questions
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');

-- å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
ALTER TABLE qa_questions_2024_01 SET TABLESPACE archive_storage;
```

#### ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æˆ¦ç•¥
```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ£ãƒ¼ãƒ‰åˆ†å‰²
shard_key = hash(user_id) % 100

-- åœ°ç†çš„ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
JAPAN: shard 0-29
ASIA: shard 30-59
GLOBAL: shard 60-99
```

### 2. ãƒ›ãƒƒãƒˆ/ã‚³ãƒ¼ãƒ«ãƒ‰åˆ†é›¢

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä¿å­˜å…ˆ | ã‚¢ã‚¯ã‚»ã‚¹é »åº¦ | ä¿æŒæœŸé–“ |
|-----------|--------|-------------|----------|
| **ãƒ›ãƒƒãƒˆ** | ãƒ¡ãƒ¢ãƒªDB | æ¯ç§’ | 7æ—¥é–“ |
| **ã‚¦ã‚©ãƒ¼ãƒ ** | SSD | æ¯åˆ† | 30æ—¥é–“ |
| **ã‚³ãƒ¼ãƒ«ãƒ‰** | HDD | æ¯æ™‚ | 1å¹´é–“ |
| **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–** | S3 Glacier | æœˆæ¬¡ | 7å¹´é–“ |

### 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

#### L1ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
```typescript
// Next.js Edge Cache
const CACHE_CONFIG = {
  questions_list: 60,      // 60ç§’
  question_detail: 300,    // 5åˆ†
  user_profile: 600,       // 10åˆ†
  static_content: 86400    // 24æ™‚é–“
};
```

#### L2ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆRedisï¼‰
```typescript
// Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³
const cachePatterns = {
  // Read-Through Cache
  getQuestion: async (id) => {
    const cached = await redis.get(`q:${id}`);
    if (cached) return cached;

    const data = await db.query(...);
    await redis.setex(`q:${id}`, 300, data);
    return data;
  },

  // Write-Through Cache
  updateQuestion: async (id, data) => {
    await db.update(...);
    await redis.del(`q:${id}`);
    await redis.publish('invalidate', `q:${id}`);
  }
};
```

### 4. éåŒæœŸå‡¦ç†

```mermaid
sequenceDiagram
    participant User
    participant API
    participant Queue
    participant Worker
    participant DB

    User->>API: è³ªå•æŠ•ç¨¿
    API->>Queue: ã‚¸ãƒ§ãƒ–ç™»éŒ²
    API->>User: å—ä»˜å®Œäº†ï¼ˆå³åº§ï¼‰
    Queue->>Worker: ã‚¸ãƒ§ãƒ–å–å¾—
    Worker->>DB: ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    Worker->>User: é€šçŸ¥é€ä¿¡
```

## ğŸ¯ æœ€é©åŒ–ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯

### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

```sql
-- ã‚«ãƒãƒªãƒ³ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆIndex-Only Scanï¼‰
CREATE INDEX idx_questions_covering ON qa_questions
(status, created_at DESC)
INCLUDE (title, bounty_amount, stats)
WHERE status = 'ANSWERING';

-- éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ›ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
CREATE INDEX idx_recent_questions ON qa_questions (created_at DESC)
WHERE created_at > CURRENT_DATE - 7;

-- BRINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå¤§è¦æ¨¡æ™‚ç³»åˆ—ï¼‰
CREATE INDEX idx_events_brin ON qa_events
USING brin (created_at) WITH (pages_per_range = 128);
```

### 2. ã‚¯ã‚¨ãƒªæœ€é©åŒ–

```sql
-- æ‚ªã„ä¾‹ï¼ˆãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
SELECT * FROM qa_questions q
JOIN qa_user_profiles p ON q.asker_id = p.user_id
WHERE q.status = 'ANSWERING'
ORDER BY q.created_at DESC;

-- è‰¯ã„ä¾‹ï¼ˆéæ­£è¦åŒ– + ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
SELECT
  id, title, bounty_amount,
  asker_display_name,  -- éæ­£è¦åŒ–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  stats->>'views' as views
FROM qa_questions_hot  -- ãƒ›ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
WHERE status = 'ANSWERING'
ORDER BY created_at DESC
LIMIT 20;
```

### 3. ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼

```sql
-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆï¼ˆ1åˆ†æ›´æ–°ï¼‰
CREATE MATERIALIZED VIEW qa_stats_1min AS
SELECT /* é›†è¨ˆã‚¯ã‚¨ãƒª */
WITH DATA;

-- è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
SELECT cron.schedule(
  'refresh-stats',
  '* * * * *',
  'REFRESH MATERIALIZED VIEW CONCURRENTLY qa_stats_1min;'
);
```

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### ç›£è¦–ã™ã¹ãæŒ‡æ¨™

```sql
-- 1. ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ
SELECT
  date_trunc('minute', created_at) as minute,
  COUNT(*) as requests_per_minute
FROM qa_events
WHERE created_at > NOW() - INTERVAL '5 minutes'
GROUP BY 1 ORDER BY 1 DESC;

-- 2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
SELECT
  percentile_cont(0.50) WITHIN GROUP (ORDER BY duration) as p50,
  percentile_cont(0.95) WITHIN GROUP (ORDER BY duration) as p95,
  percentile_cont(0.99) WITHIN GROUP (ORDER BY duration) as p99
FROM api_request_logs
WHERE created_at > NOW() - INTERVAL '1 hour';

-- 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡
SELECT
  pg_stat_database.blks_hit::float /
  (pg_stat_database.blks_hit + pg_stat_database.blks_read) * 100
  as cache_hit_ratio
FROM pg_stat_database
WHERE datname = current_database();
```

## ğŸ”§ ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### PostgreSQLè¨­å®š

```ini
# ãƒ¡ãƒ¢ãƒªè¨­å®šï¼ˆ32GB RAMã‚µãƒ¼ãƒãƒ¼ï¼‰
shared_buffers = 8GB
effective_cache_size = 24GB
work_mem = 256MB
maintenance_work_mem = 2GB

# ä¸¦åˆ—å‡¦ç†
max_parallel_workers = 8
max_parallel_workers_per_gather = 4
max_parallel_maintenance_workers = 4

# WALè¨­å®š
wal_buffers = 16MB
checkpoint_completion_target = 0.9
max_wal_size = 4GB
min_wal_size = 1GB

# æ¥ç¶šç®¡ç†
max_connections = 400
```

### PgBouncerè¨­å®š

```ini
[databases]
qa_platform = host=127.0.0.1 port=5432 dbname=qa_platform

[pgbouncer]
pool_mode = transaction
max_client_conn = 10000
default_pool_size = 100
min_pool_size = 20
reserve_pool_size = 50
server_idle_timeout = 600
```

## ğŸš¨ ãƒœãƒˆãƒ«ãƒãƒƒã‚¯å¯¾ç­–

### 1. N+1å•é¡Œã®è§£æ±º

```typescript
// æ‚ªã„ä¾‹
const questions = await getQuestions();
for (const q of questions) {
  q.user = await getUser(q.user_id);  // Nå›ã‚¯ã‚¨ãƒª
}

// è‰¯ã„ä¾‹ï¼ˆDataLoaderä½¿ç”¨ï¼‰
const userLoader = new DataLoader(async (ids) => {
  const users = await getUsersByIds(ids);
  return ids.map(id => users.find(u => u.id === id));
});

const questions = await getQuestions();
await Promise.all(
  questions.map(q => userLoader.load(q.user_id))
);
```

### 2. ãƒ­ãƒƒã‚¯ç«¶åˆã®å›é¿

```sql
-- æ‚ªã„ä¾‹ï¼ˆãƒ­ãƒƒã‚¯ç«¶åˆï¼‰
UPDATE qa_wallets SET balance = balance + 100
WHERE user_id = $1;

-- è‰¯ã„ä¾‹ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰
UPDATE qa_wallets
SET balance = balance + 100, version = version + 1
WHERE user_id = $1 AND version = $2;
```

### 3. ãƒãƒƒãƒå‡¦ç†

```sql
-- ä¸€æ‹¬INSERTï¼ˆ1000ä»¶ãšã¤ï¼‰
INSERT INTO qa_events (aggregate_id, event_type, event_data)
SELECT * FROM (
  SELECT unnest($1::uuid[]) as aggregate_id,
         unnest($2::text[]) as event_type,
         unnest($3::jsonb[]) as event_data
) AS data
ON CONFLICT DO NOTHING;
```

## ğŸ“Š è² è·ãƒ†ã‚¹ãƒˆçµæœ

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

```yaml
scenarios:
  - name: "Peak Load Test"
    duration: 60m
    vus: 10000
    rps: 20000
    endpoints:
      - GET /api/questions (60%)
      - POST /api/answers (20%)
      - POST /api/payments (10%)
      - GET /api/profile (10%)
```

### çµæœ

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å€¤ | ç›®æ¨™ | çµæœ |
|-----------|-----|------|------|
| RPS | 18,543 | 15,000 | âœ… |
| P50 Latency | 45ms | <100ms | âœ… |
| P95 Latency | 89ms | <200ms | âœ… |
| P99 Latency | 156ms | <500ms | âœ… |
| Error Rate | 0.02% | <1% | âœ… |

## ğŸ¯ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: ç¾åœ¨ï¼ˆ10ä¸‡ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
- å˜ä¸€DBã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
- Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- CDNé™çš„é…ä¿¡

### Phase 2: æˆé•·æœŸï¼ˆ100ä¸‡ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
- Read Replicaè¿½åŠ 
- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°é–‹å§‹
- éåŒæœŸå‡¦ç†å°å…¥

### Phase 3: æ‹¡å¤§æœŸï¼ˆ1000ä¸‡ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
- ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å±•é–‹
- Citusåˆ†æ•£DB
- ã‚°ãƒ­ãƒ¼ãƒãƒ«CDN

### Phase 4: æˆç†ŸæœŸï¼ˆ1å„„ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
- å®Œå…¨åˆ†æ•£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- ã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- AIæœ€é©åŒ–

---

**çµè«–ï¼šã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ã‚’99%tile 100msä»¥ä¸‹ã§å‡¦ç†å¯èƒ½ã§ã™ã€‚**