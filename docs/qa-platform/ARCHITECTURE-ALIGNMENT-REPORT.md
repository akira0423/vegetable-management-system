# 🔍 Q&Aプラットフォーム アーキテクチャ整合性レポート

## 📊 現在の実装と要求設計の比較分析

### 1. 情報アーキテクチャ（サイトマップ）の差異

#### 現在の実装
```
/qa/
├─ /qa                            # メインページ（質問一覧）
├─ /qa/questions                  # 質問一覧（検索・フィルター機能付き）
├─ /qa/new                        # 質問投稿
├─ /qa/{id}                       # 質問詳細
├─ /qa/admin                      # 管理画面
└─ /qa/test-responder            # テスト用
```

#### 要求設計
```
/
├─ /questions                     # 一覧（タグ・検索・並び替え）
├─ /questions/new                 # 質問投稿
├─ /questions/{qid}               # 質問詳細
│  ├─ /open-full                  # 全文開封
│  ├─ /ppv                        # PPV購入
│  └─ /best                       # ベスト選定
├─ /answers/{aid}                 # 回答詳細
├─ /profile/{uid}                 # プロフィール
├─ /wallet                        # ウォレット
├─ /invoices                      # 請求書
└─ /admin                         # 管理
```

#### 📝 必要な対応
- ❌ ルーティング構造の変更（/qa/* → /questions/*）
- ❌ サブルートの追加（open-full, ppv, best）
- ❌ 新規ページの実装（wallet, invoices, profile, answers）

---

### 2. データベース設計の差異

#### 現在の実装
```sql
-- 回答本文が直接qa_answersテーブルに格納
CREATE TABLE qa_answers (
    id UUID PRIMARY KEY,
    body TEXT NOT NULL,  -- 本文が直接格納
    -- ...
);
```

#### 要求設計
```sql
-- 回答メタデータと本文を分離
CREATE TABLE qa_answers (
    id UUID PRIMARY KEY,
    body_preview TEXT,  -- ティーザーのみ
    -- メタデータのみ
);

CREATE TABLE qa_answer_contents (
    answer_id UUID PRIMARY KEY REFERENCES qa_answers(id),
    body TEXT NOT NULL,  -- 本文を分離管理
    -- ...
);
```

#### 📝 必要な対応
- ❌ qa_answer_contentsテーブルの新規作成
- ❌ 既存データの移行スクリプト
- ❌ RLSポリシーの再設計

---

### 3. RLS（Row Level Security）ポリシーの差異

#### 現在の実装
```sql
-- 質問本文: 公開済みは全員閲覧可能 ✅
-- 回答本文: 質問者/回答者/PPV購入者のみ（分離なし）
```

#### 要求設計
```sql
-- 質問本文: 全員フル表示（SEO最大化） ✅
-- 回答メタ: 全員閲覧可能
-- 回答本文: 厳格な制限
  - 質問者: 全回答の本文閲覧可能
  - 回答者: 自分の回答のみ本文閲覧可能
  - PPV購入者: 全回答の本文閲覧可能
  - その他: ティーザーのみ
```

---

## 🎯 実装ステータス評価

### ✅ 実装済み機能（要求を満たしている）
1. **質問本文の全公開**
   - published_atがNULLでない質問は誰でも閲覧可能
   - SEO/集客の最大化を実現

2. **基本的な質問投稿フロー**
   - 下書き → 与信 → 公開の流れ
   - Stripe PaymentIntentの実装

3. **検索・フィルタリング機能**
   - 高度な検索クエリ解析
   - 複数条件でのフィルタリング
   - パフォーマンス最適化

### ⚠️ 部分的実装（改善が必要）
1. **回答本文の可視性制御**
   - 現状: bodyが直接qa_answersにある
   - 必要: qa_answer_contentsへの分離

2. **ルーティング構造**
   - 現状: /qa/* 配下
   - 必要: /questions/* への変更

### ❌ 未実装機能
1. **ページ機能**
   - /wallet（ウォレット）
   - /invoices（請求書）
   - /profile/{uid}（プロフィール）
   - /answers/{aid}（回答詳細）
   - /questions/{qid}/open-full（全文開封）
   - /questions/{qid}/ppv（PPV購入）
   - /questions/{qid}/best（ベスト選定）

2. **データベース**
   - qa_answer_contentsテーブル
   - 回答本文の分離管理

3. **決済関連**
   - PPVプール分配ロジック
   - 出金機能（¥3,000以上、手数料¥250）

---

## 📋 優先度別の改善計画

### Priority 1: データベース改善（必須）
1. **qa_answer_contentsテーブル作成**
   - 回答本文の分離
   - 既存データの移行
   - RLSポリシー設定

### Priority 2: ルーティング整合性（推奨）
1. **URL構造の変更**
   - /qa/* → /questions/* への移行
   - リダイレクト設定

### Priority 3: 機能追加（段階的）
1. **必須ページ**
   - ウォレット
   - プロフィール
   - 回答詳細

2. **決済関連**
   - PPV購入フロー
   - 出金機能

---

## 🚀 実装方針の提案

### Option A: 段階的移行（推奨）
1. **Phase 1**: データベース改善のみ実施
   - qa_answer_contentsテーブル追加
   - RLSポリシー更新
   - APIの調整

2. **Phase 2**: ルーティング調整
   - 新URLでの並行運用
   - 段階的移行

3. **Phase 3**: 機能追加
   - 新規ページの実装

### Option B: 現状維持＋拡張
1. 現在の/qa/*構造を維持
2. 回答本文分離のみ実装
3. 新機能は/qa/*配下に追加

### Option C: 完全リニューアル
1. 要求設計通りに全面再構築
2. 既存実装の並行運用
3. データ移行後に切り替え

---

## 📊 整合性スコア

| カテゴリ | 現状スコア | 目標スコア | ギャップ |
|---------|-----------|-----------|----------|
| データモデル | 70% | 100% | -30% |
| ルーティング | 60% | 100% | -40% |
| 機能充足度 | 65% | 100% | -35% |
| RLS制御 | 75% | 100% | -25% |
| **総合評価** | **67.5%** | **100%** | **-32.5%** |

---

## 📝 結論

現在の実装は基本機能を満たしていますが、以下の重要な設計要件に差異があります：

1. **回答本文の分離管理**が最優先課題
2. **ルーティング構造**の整合性確保
3. **未実装ページ**の段階的追加

推奨アプローチは「**Option A: 段階的移行**」です。