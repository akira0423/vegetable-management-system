'use client'

import { useState, useEffect, useCallback } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { analyticsDataSync } from '@/lib/analytics-data-sync'
import { accountingAnalyticsProcessor } from '@/lib/accounting-analytics-processor'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Switch } from '@/components/ui/switch'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { 
  BarChart3,
  TrendingUp,
  TrendingDown,
  DollarSign,
  Sprout,
  Calendar,
  Download,
  FileSpreadsheet,
  PieChart,
  Activity,
  Target,
  Zap,
  Users,
  MapPin,
  Clock,
  Award,
  AlertTriangle,
  Eye,
  RefreshCw,
  Microscope,
  Network,
  CheckCircle,
  Info,
  FileText,
  Brain
} from 'lucide-react'
import DataExportDialog from '@/components/data-export-dialog'
import MonthlyCashflowChart from '@/components/charts/monthly-cashflow-chart'
import MonthlyWorkHoursChart from '@/components/charts/monthly-workhours-chart'
import SoilDetailChart from '@/components/charts/soil-detail-chart'
import FinancialPerformanceChart from '@/components/charts/financial-performance-chart'
import WorkTypeAnalysisReport from '@/components/work-type-analysis-report'

// „ÉÅ„É£„Éº„Éà„Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÔºà„Ç∑„É≥„Éó„É´„Å™CSSÂÆüË£ÖÔºâ
interface ChartData {
  label: string
  value: number
  color?: string
}

const SimpleBarChart = ({ data, height = 200, title }: { data: ChartData[], height?: number, title?: string }) => {
  const maxValue = Math.max(...data.map(d => d.value))
  
  return (
    <div className="space-y-2">
      {title && <h4 className="text-sm font-medium text-gray-700">{title}</h4>}
      <div className="flex items-end space-x-2" style={{ height }}>
        {data.map((item, index) => (
          <div key={index} className="flex flex-col items-center space-y-1 flex-1">
            <div className="w-full bg-gray-100 rounded-t flex items-end justify-center relative">
              <div
                className={`w-full rounded-t transition-all duration-500 flex items-end justify-center text-xs font-medium text-white ${
                  item.color || 'bg-green-500'
                }`}
                style={{
                  height: `${(item.value / maxValue) * (height - 40)}px`,
                  minHeight: item.value > 0 ? '20px' : '2px'
                }}
              >
                {item.value > 0 && <span className="pb-1">{item.value}</span>}
              </div>
            </div>
            <span className="text-xs text-gray-600 text-center">{item.label}</span>
          </div>
        ))}
      </div>
    </div>
  )
}

const SimpleLineChart = ({ data, height = 200, title }: { data: ChartData[], height?: number, title?: string }) => {
  const maxValue = Math.max(...data.map(d => d.value))
  const minValue = Math.min(...data.map(d => d.value))
  const range = maxValue - minValue || 1
  
  return (
    <div className="space-y-2">
      {title && <h4 className="text-sm font-medium text-gray-700">{title}</h4>}
      <div className="relative" style={{ height }}>
        <div className="absolute inset-0 border border-gray-200 rounded bg-gray-50">
          <svg width="100%" height="100%" className="overflow-visible">
            <polyline
              fill="none"
              stroke="#10b981"
              strokeWidth="3"
              points={data.map((item, index) => {
                const x = (index / (data.length - 1)) * 100
                const y = 100 - ((item.value - minValue) / range) * 80
                return `${x}%,${y}%`
              }).join(' ')}
            />
            {data.map((item, index) => {
              const x = (index / (data.length - 1)) * 100
              const y = 100 - ((item.value - minValue) / range) * 80
              return (
                <circle
                  key={index}
                  cx={`${x}%`}
                  cy={`${y}%`}
                  r="4"
                  fill="#10b981"
                  stroke="white"
                  strokeWidth="2"
                />
              )
            })}
          </svg>
        </div>
        <div className="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-600 pt-2">
          {data.map((item, index) => (
            <span key={index} className="text-center">{item.label}</span>
          ))}
        </div>
      </div>
    </div>
  )
}

interface AnalyticsData {
  summary: {
    total_revenue: number
    total_cost: number
    profit_margin: number
    total_harvest: number
    total_work_hours: number
    avg_yield_per_sqm: number
    active_plots: number
    completed_harvests: number
    efficiency_score: number
  }
  dataQuality?: {
    incomeSource: 'accounting' | 'estimated' | 'none'
    expenseSource: 'accounting' | 'estimated' | 'none'
    reliability: 'high' | 'medium' | 'low'
    accountingCoverage?: number
  }
  harvest_analysis: ChartData[]
  cost_analysis: ChartData[]
  efficiency_trends: ChartData[]
  seasonal_performance: ChartData[]
  work_frequency?: ChartData[] // ‰ΩúÊ•≠È¢ëÂ∫¶„Éá„Éº„Çø„ÇíËøΩÂä†
  vegetable_performance: Array<{
    name: string
    variety: string
    plot_size: number
    harvest_amount: number
    revenue: number
    cost: number
    profit: number
    yield_per_sqm: number
    roi: number
    status: 'excellent' | 'good' | 'average' | 'poor'
  }>
  recent_activities: Array<{
    id: string
    type: 'harvest' | 'cost' | 'efficiency' | 'alert'
    title: string
    description: string
    value?: number
    timestamp: string
  }>
}

export default function AnalyticsPage() {
  const [data, setData] = useState<AnalyticsData | null>(null)
  const [loading, setLoading] = useState(true)
  const [selectedVegetable, setSelectedVegetable] = useState('all')
  const [availableVegetables, setAvailableVegetables] = useState<Array<{id: string, name: string}>>([])
  const [vegetableOptions, setVegetableOptions] = useState<Array<{id: string, name: string}>>([{id: 'all', name: '„Åô„Åπ„Å¶„ÅÆÈáéËèú'}])
  const [vegetablesData, setVegetablesData] = useState<any[]>([])
  const [selectedPlot, setSelectedPlot] = useState('all')
  const [lastUpdated, setLastUpdated] = useState<Date>(new Date())
  const [autoRefresh, setAutoRefresh] = useState(true)
  const [companyId, setCompanyId] = useState<string | null>(null)
  const [authError, setAuthError] = useState<string | null>(null)

  // „Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÅØÂâäÈô§Ê∏à„Åø - ÂÆü„Éá„Éº„Çø„ÅÆ„Åø„Çí‰ΩøÁî®

  // Ë™çË®ºÊÉÖÂ†±„ÅÆÂèñÂæó
  useEffect(() => {
    const fetchUserAuth = async () => {
      try {
        console.log('üîç Analytics: Ë™çË®ºÊÉÖÂ†±ÂèñÂæóÈñãÂßã')
        const response = await fetch('/api/auth/user')
        
        if (!response.ok) {
          throw new Error(`Ë™çË®º„Ç®„É©„Éº: ${response.status}`)
        }
        
        const result = await response.json()
        
        if (result.success && result.user?.company_id) {
          console.log('‚úÖ Analytics: Ë™çË®ºÊàêÂäü, company_id:', result.user.company_id)
          setCompanyId(result.user.company_id)
          setAuthError(null)
        } else {
          throw new Error('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
        }
      } catch (error) {
        console.error('‚ùå Analytics: Ë™çË®º„Ç®„É©„Éº:', error)
        setAuthError(error instanceof Error ? error.message : 'Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü')
        setCompanyId(null)
      }
    }
    
    fetchUserAuth()
  }, [])

  // „Éá„Éº„Çø„ÅÆÂèñÂæóÔºàcompanyId„ÅåÂèñÂæó„Åß„Åç„ÅüÂæå„Å´ÂÆüË°åÔºâ
  useEffect(() => {
    if (companyId) {
      console.log('üìä Analytics: companyIdÂèñÂæóÂÆå‰∫Ü„ÄÅ„Éá„Éº„Çø„Éï„Çß„ÉÉ„ÉÅÈñãÂßã:', companyId)
      fetchAnalyticsData()
    }
  }, [companyId, selectedVegetable, selectedPlot])

  // „É™„Ç¢„É´„Çø„Ç§„É†„Éá„Éº„ÇøÂêåÊúü„É™„Çπ„Éä„Éº
  const handleAnalyticsUpdate = useCallback((updateData: any) => {
    console.log('„É™„Ç¢„É´„Çø„Ç§„É†„Éá„Éº„ÇøÊõ¥Êñ∞:', updateData)
    
    // Êó¢Â≠ò„Éá„Éº„Çø„Å®„Éû„Éº„Ç∏
    if (data && updateData.metrics) {
      const updatedData = {
        ...data,
        summary: {
          ...data.summary,
          total_revenue: data.summary.total_revenue + (updateData.data.expected_revenue || 0),
          total_cost: data.summary.total_cost,
          total_harvest: data.summary.total_harvest + (updateData.data.harvest_amount || 0)
        },
        recent_activities: [
          {
            id: `activity_${Date.now()}`,
            type: updateData.data.work_type === 'harvesting' ? 'harvest' as const : 'cost' as const,
            title: `Êñ∞„Åó„ÅÑ${updateData.data.work_type}‰ΩúÊ•≠„ÅåÂÆå‰∫Ü`,
            description: updateData.data.work_notes || '‰ΩúÊ•≠„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü',
            value: updateData.data.expected_revenue || updateData.data.harvest_amount || 0,
            timestamp: updateData.timestamp
          },
          ...data.recent_activities.slice(0, 4) // ÊúÄÊñ∞5‰ª∂„Åæ„Åß‰øùÊåÅ
        ]
      }
      setData(updatedData)
      setLastUpdated(new Date())
    }
  }, [data])

  useEffect(() => {
    // „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„É™„Çπ„Éä„ÉºÁôªÈå≤
    analyticsDataSync.addListener(handleAnalyticsUpdate)
    
    return () => {
      // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      analyticsDataSync.removeListener(handleAnalyticsUpdate)
    }
  }, [handleAnalyticsUpdate])

  // Ëá™ÂãïÊõ¥Êñ∞Ê©üËÉΩÔºà5ÂàÜ„Åî„Å®Ôºâ
  useEffect(() => {
    if (!autoRefresh || !companyId) return
    
    const interval = setInterval(() => {
      fetchAnalyticsData()
      console.log('ÂàÜÊûê„Éá„Éº„Çø„ÅåËá™ÂãïÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü')
    }, 5 * 60 * 1000) // 5ÂàÜ„Åî„Å®
    
    return () => clearInterval(interval)
  }, [autoRefresh, companyId, selectedVegetable, selectedPlot])

  const fetchAnalyticsData = async () => {
    if (!companyId) {
      console.log('‚ùå Analytics: companyId„ÅåÊú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅ„ÄÅ„Éá„Éº„ÇøÂèñÂæó„Çí„Çπ„Ç≠„ÉÉ„Éó')
      return
    }
    
    try {
      console.log('üìä Analytics: „Éá„Éº„ÇøÂèñÂæóÈñãÂßã, companyId:', companyId)
      setLoading(true)
      
      // Áõ¥Ëøë12„Ç´Êúà„ÅÆÊúüÈñì„ÇíË®àÁÆó
      const endDate = new Date()
      const startDate = new Date()
      startDate.setFullYear(startDate.getFullYear() - 1)

      // ‰ΩúÊ•≠„É¨„Éù„Éº„Éà„Éá„Éº„Çø„Å®ÈáéËèú„Éá„Éº„Çø„Çí‰∏¶Ë°åÂèñÂæó
      const [reportsResponse, vegetablesResponse, ganttResponse] = await Promise.all([
        fetch(`/api/reports?company_id=${companyId}&start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}&limit=999999`),  // ÂÆüË≥™ÁÑ°Âà∂Èôê
        fetch(`/api/gantt?company_id=${companyId}&start_date=2024-01-01&end_date=2025-12-31`),
        fetch(`/api/gantt?company_id=${companyId}&start_date=2024-01-01&end_date=2025-12-31`)
      ])
      
      let workReports = []
      let vegetables = []
      let tasks = []
      
      // ‰ΩúÊ•≠„É¨„Éù„Éº„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó
      if (reportsResponse.ok) {
        const reportsResult = await reportsResponse.json()
        if (reportsResult.success) {
          workReports = reportsResult.data
        }
      }
      
      // ÈáéËèú„Éá„Éº„Çø„ÅÆÂèñÂæó
      if (vegetablesResponse.ok) {
        const vegetablesResult = await vegetablesResponse.json()
        if (vegetablesResult.success && vegetablesResult.data.vegetables) {
          vegetables = vegetablesResult.data.vegetables
          setVegetablesData(vegetables) // ÂÆåÂÖ®„Å™ÈáéËèú„Éá„Éº„Çø„Çí‰øùÂ≠ò

          // ÈáéËèú„Ç™„Éó„Ç∑„Éß„É≥„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
          const vegOptions = vegetables.map((veg: any) => ({
            id: veg.id,
            name: veg.name.split('Ôºà')[0] || veg.name
          }))
          setAvailableVegetables(vegOptions)
          setVegetableOptions([{id: 'all', name: '„Åô„Åπ„Å¶„ÅÆÈáéËèú'}, ...vegOptions])
        }
      }
      
      // „Çø„Çπ„ÇØ„Éá„Éº„Çø„ÅÆÂèñÂæó
      if (ganttResponse.ok) {
        const ganttResult = await ganttResponse.json()
        if (ganttResult.success && ganttResult.data.tasks) {
          tasks = ganttResult.data.tasks
        }
      }
      
      // „Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫Áä∂ÊÖã„ÇíÁ∂≠ÊåÅ
      console.log('üìä ÂàÜÊûê„Éá„Éº„ÇøÂèñÂæóÁµêÊûú:', {
        ‰ΩúÊ•≠„É¨„Éù„Éº„ÉàÊï∞: workReports.length,
        ÈáéËèú„Éá„Éº„ÇøÊï∞: vegetables ? vegetables.length : 0,
        „Çø„Çπ„ÇØ„Éá„Éº„ÇøÊï∞: tasks.length
      })
      
      // ÈÅ∏Êäû„Åï„Çå„ÅüÈáéËèú„Å´„Çà„Çã„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
      let filteredWorkReports = workReports
      let filteredVegetables = vegetables

      if (selectedVegetable !== 'all') {
        const selectedVegId = selectedVegetable
        filteredWorkReports = workReports.filter((report: any) => report.vegetable_id === selectedVegId)
        filteredVegetables = vegetables && vegetables.length > 0 ? vegetables.filter((veg: any) => veg.id === selectedVegId) : []
      }

      console.log('üîç Analytics: „Éï„Ç£„É´„Çø„ÉºÂæå„ÅÆ„Éá„Éº„Çø', {
        ÈÅ∏ÊäûÈáéËèú: selectedVegetable,
        „Éï„Ç£„É´„Çø„ÉºÂæå‰ΩúÊ•≠„É¨„Éù„Éº„ÉàÊï∞: filteredWorkReports.length,
        „Éï„Ç£„É´„Çø„ÉºÂæåÈáéËèúÊï∞: filteredVegetables.length
      })

      // ‰ΩúÊ•≠„É¨„Éù„Éº„Éà„Åã„ÇâÂàÜÊûê„Éá„Éº„Çø„ÇíÁîüÊàêÔºàÁõ¥Ëøë12„Ç´Êúà„Éá„Éº„ÇøÔºâ
      if (filteredWorkReports.length > 0 || filteredVegetables.length > 0) {
        // Áõ¥Ëøë12„Ç´Êúà„ÅÆ„Éá„Éº„Çø„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        const twelveMonthsAgo = new Date()
        twelveMonthsAgo.setFullYear(twelveMonthsAgo.getFullYear() - 1)
        const last12MonthsReports = filteredWorkReports.filter((report: any) => {
          const reportDate = new Date(report.work_date)
          return reportDate >= twelveMonthsAgo
        })
        
        console.log('üìÖ Áõ¥Ëøë12„Ç´Êúà„Éá„Éº„Çø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞:', {
          total_reports: filteredWorkReports.length,
          last_12_months: last12MonthsReports.length,
          period: `${twelveMonthsAgo.toLocaleDateString('ja-JP')} ~ ${new Date().toLocaleDateString('ja-JP')}`
        })
        
        const analyticsFromReports = generateDetailedAnalyticsFromReports(last12MonthsReports, filteredVegetables)
        // „Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÅØ‰ΩøÁî®„Åõ„Åö„ÄÅÂÆü„Éá„Éº„Çø„ÅÆ„Åø„Çí‰ΩøÁî®
        const realData = createRealAnalyticsData(analyticsFromReports)
        setData(realData)
      } else {
        // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ null „ÇíË®≠ÂÆöÔºàÁ©∫Áä∂ÊÖãË°®Á§∫Áî®Ôºâ
        setData(null)
      }
      setLastUpdated(new Date())
      setLoading(false)
      
    } catch (error) {
      console.error('ÂàÜÊûê„Éá„Éº„Çø„ÅÆÂèñÂæó„Ç®„É©„Éº:', error)
      // „Ç®„É©„ÉºÊôÇ„ÅØÁ©∫Áä∂ÊÖã„ÇíË°®Á§∫
      setData(null)
      setLastUpdated(new Date())
      setLoading(false)
    }
  }

  // ‰ΩúÊ•≠„É¨„Éù„Éº„Éà„Åã„ÇâË©≥Á¥∞ÂàÜÊûê„Éá„Éº„Çø„ÇíÁîüÊàêÔºà‰ºöË®à„Éá„Éº„ÇøÁµ±ÂêàÁâàÔºâ
  const generateDetailedAnalyticsFromReports = (reports: any[], vegetables: any[]) => {
    // ÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Çí‰ΩøÁî®Ôºà„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑÔºâ
    if (!reports || reports.length === 0) {
      // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫„ÅÆÂàÜÊûêÁµêÊûú„ÇíËøî„Åô
      return {
        harvestByMonth: {},
        costByType: {},
        workFrequency: {},
        vegetablePerformance: [],
        totalRevenue: 0,
        totalCost: 0,
        totalHarvest: 0,
        totalWorkHours: 0,
        profitMargin: 0,
        recentActivities: [],
        dataQuality: {
          incomeSource: 'none',
          expenseSource: 'none',
          reliability: 'low'
        }
      }
    }

    console.log('üîç Analytics: ‰ºöË®àÁµ±Âêà„Éá„Éº„ÇøÂá¶ÁêÜÈñãÂßã', { reportCount: reports.length })

    // ÊúàÂà•ÂèéÁ©´Èáè„Éá„Éº„ÇøÁîüÊàêÔºàÂπ¥Ë∑®„ÅéÂØæÂøúÔºâ
    const harvestByMonth = reports
      .filter(r => r.work_type === 'harvesting' && r.harvest_amount)
      .reduce((acc: any, report) => {
        const date = new Date(report.work_date)
        const month = date.getMonth() + 1
        const monthKey = `${month}Êúà`
        acc[monthKey] = (acc[monthKey] || 0) + report.harvest_amount
        return acc
      }, {})

    // ‰ºöË®à„Éá„Éº„ÇøÁµ±Âêà„Çí‰ΩøÁî®„Åó„Åü„Ç≥„Çπ„ÉàÂàÜÊûê
    const costByType: {[key: string]: number} = {}
    let totalActualRevenue = 0
    let totalActualCost = 0
    let totalEstimatedRevenue = 0
    let totalEstimatedCost = 0
    let revenueFromAccounting = 0
    let expenseFromAccounting = 0

    reports.forEach(report => {
      // ‰ºöË®àÁµ±Âêà„Éó„É≠„Çª„ÉÉ„Çµ„Éº„Çí‰ΩøÁî®„Åó„Å¶„Éá„Éº„ÇøÂèñÂæóÔºàÊé®ÂÆöË®àÁÆó„Å™„ÅóÔºâ
      const incomeData = accountingAnalyticsProcessor.getIncomeDataWithSource(report, false)
      const costData = accountingAnalyticsProcessor.getCostDataWithSource(report, false)

      // ÂèéÂÖ•„Éá„Éº„Çø„ÅÆÈõÜË®àÔºà‰ºöË®à„Éá„Éº„Çø„ÅÆ„ÅøÔºâ
      totalActualRevenue += incomeData.amount
      if (incomeData.amount > 0) {
        revenueFromAccounting += incomeData.amount
      }

      // ÊîØÂá∫„Éá„Éº„Çø„ÅÆÈõÜË®àÔºà‰ºöË®à„Éá„Éº„Çø„ÅÆ„ÅøÔºâ
      totalActualCost += costData.amount
      if (costData.amount > 0) {
        expenseFromAccounting += costData.amount
      }

      // ‰ΩúÊ•≠Á®ÆÂà•„Ç≥„Çπ„ÉàÂàÜÈ°û
      const typeLabels: any = {
        seeding: 'Á®ÆËãóË≤ª',
        planting: 'ÂÆöÊ§çË≤ª',
        fertilizing: 'ËÇ•ÊñôË≤ª',
        watering: 'ÁÅåÊ∞¥Ë≤ª',
        weeding: 'Èô§ËçâË≤ª',
        pruning: 'Êï¥ÊûùË≤ª',
        harvesting: 'ÂèéÁ©´Ë≤ª',
        other: '„Åù„ÅÆ‰ªñ'
      }
      const label = typeLabels[report.work_type] || '„Åù„ÅÆ‰ªñ'
      costByType[label] = (costByType[label] || 0) + costData.amount
    })

    // „Éá„Éº„ÇøÂìÅË≥™„É°„Éà„É™„ÇØ„Çπ
    const dataQuality = {
      incomeSource: revenueFromAccounting > totalEstimatedRevenue ? 'accounting' : 'estimated',
      expenseSource: expenseFromAccounting > totalEstimatedCost ? 'accounting' : 'estimated',
      reliability: revenueFromAccounting > 0 && expenseFromAccounting > 0 ? 'high' : 
                   revenueFromAccounting > 0 || expenseFromAccounting > 0 ? 'medium' : 'low',
      accountingCoverage: reports.length > 0 ? 
        (reports.filter(r => r.work_report_accounting && r.work_report_accounting.length > 0).length / reports.length) * 100 : 0
    }

    console.log('üí∞ Analytics: ‰ºöË®à„Éá„Éº„ÇøÁµ±ÂêàÁµêÊûú', {
      totalActualRevenue,
      totalActualCost,
      totalEstimatedRevenue,
      totalEstimatedCost,
      dataQuality
    })

    // ‰ΩúÊ•≠Á®ÆÂà•È¢ëÂ∫¶ÂàÜÊûê
    const workFrequency = reports.reduce((acc: any, report) => {
      const typeLabels: any = {
        seeding: 'Êí≠Á®Æ',
        planting: 'ÂÆöÊ§ç',
        fertilizing: 'ÊñΩËÇ•',
        watering: 'ÁÅåÊ∞¥',
        weeding: 'Èô§Ëçâ',
        pruning: 'Êï¥Êûù',
        harvesting: 'ÂèéÁ©´',
        other: '„Åù„ÅÆ‰ªñ'
      }
      const label = typeLabels[report.work_type] || '„Åù„ÅÆ‰ªñ'
      acc[label] = (acc[label] || 0) + 1
      return acc
    }, {})

    // ÈáéËèúÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂàÜÊûêÔºà‰ºöË®à„Éá„Éº„ÇøÁµ±ÂêàÔºâ
    const vegetablePerformance = vegetables && vegetables.length > 0 ? vegetables.map((veg: any) => {
      const vegReports = reports.filter(r => r.vegetable_id === veg.id)

      let totalRevenue = 0
      let totalCost = 0

      vegReports.forEach(report => {
        const incomeData = accountingAnalyticsProcessor.getIncomeDataWithSource(report, false)
        const costData = accountingAnalyticsProcessor.getCostDataWithSource(report, false)
        totalRevenue += incomeData.amount
        totalCost += costData.amount
      })

      const totalHarvest = vegReports
        .filter(r => r.harvest_amount)
        .reduce((sum, r) => sum + r.harvest_amount, 0)

      const profit = totalRevenue - totalCost
      const roi = totalCost > 0 ? (profit / totalCost) * 100 : 0

      let status: 'excellent' | 'good' | 'average' | 'poor' = 'average'
      if (roi > 120) status = 'excellent'
      else if (roi > 80) status = 'good'
      else if (roi < 50) status = 'poor'

      return {
        name: veg.name.split('Ôºà')[0] || veg.name,
        variety: veg.variety || veg.name.match(/Ôºà(.+?)Ôºâ/)?.[1] || '',
        plot_size: 100,
        harvest_amount: totalHarvest,
        revenue: totalRevenue,
        cost: totalCost,
        profit: profit,
        yield_per_sqm: totalHarvest / 100,
        roi: roi,
        status: status
      }
    }) : []

    // Á∑èË®àÁÆóÔºàÂÆüÁ∏æ„Éá„Éº„Çø„ÇíÂÑ™ÂÖàÔºâ
    const totalRevenue = totalActualRevenue + totalEstimatedRevenue
    const totalCost = totalActualCost + totalEstimatedCost

    const totalHarvest = reports
      .filter(r => r.harvest_amount)
      .reduce((sum, report) => sum + report.harvest_amount, 0)

    // Á∑è‰ΩúÊ•≠ÊôÇÈñì„ÅÆË®àÁÆóÔºà‰∫∫ÊôÇÔºöwork_duration(ÂàÜ) √ó worker_countÔºâ
    const totalWorkHours = reports
      .reduce((sum, report) => {
        // work_durationÔºàÂàÜÂçò‰ΩçÔºâ„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞0
        const minutes = report.work_duration || 0
        const workers = report.worker_count || 1
        return sum + (minutes * workers) / 60 // ÊôÇÈñìÂçò‰Ωç„Å´Â§âÊèõ
      }, 0)

    // ÊúÄËøë„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ÁîüÊàêÔºà‰ºöË®à„Éá„Éº„ÇøÊÉÖÂ†±‰ªò„ÅçÔºâ
    const recentActivities = reports
      .slice(-5)
      .map((report, index) => {
        const vegetableName = vegetables && vegetables.length > 0
          ? vegetables.find(v => v.id === report.vegetable_id)?.name || 'Êú™Áü•„ÅÆÈáéËèú'
          : 'Êú™Áü•„ÅÆÈáéËèú'
        const workTypeNames: any = {
          harvesting: 'ÂèéÁ©´',
          fertilizing: 'ÊñΩËÇ•',
          pruning: 'Êï¥Êûù',
          seeding: 'Êí≠Á®Æ',
          planting: 'ÂÆöÊ§ç',
          watering: 'ÁÅåÊ∞¥',
          weeding: 'Èô§Ëçâ'
        }
        const workTypeName = workTypeNames[report.work_type] || report.work_type
        
        const incomeData = accountingAnalyticsProcessor.getIncomeDataWithSource(report, false)
        const costData = accountingAnalyticsProcessor.getCostDataWithSource(report, false)
        
        return {
          id: report.id || `act_${index}`,
          type: report.work_type === 'harvesting' ? 'harvest' as const : 'cost' as const,
          title: `${vegetableName}„ÅÆ${workTypeName}‰ΩúÊ•≠`,
          description: `${report.description || workTypeName + '‰ΩúÊ•≠„ÇíÂÆüÊñΩ'}Ôºà${costData.badge}„Éá„Éº„ÇøÔºâ`,
          value: report.work_type === 'harvesting' ? incomeData.amount : costData.amount,
          timestamp: new Date(report.work_date).toISOString()
        }
      })
      .reverse()

    return {
      harvestByMonth,
      costByType,
      workFrequency,
      vegetablePerformance,
      totalRevenue,
      totalCost,
      totalHarvest,
      totalWorkHours,
      profitMargin: totalRevenue > 0 ? ((totalRevenue - totalCost) / totalRevenue) * 100 : 0,
      recentActivities,
      dataQuality
    }
  }

  // ÂÆü„Éá„Éº„Çø„ÅÆ„Åø„Åã„ÇâÂàÜÊûê„Éá„Éº„Çø„Çí‰ΩúÊàê
  const createRealAnalyticsData = (reportsData: any): AnalyticsData => {
    // ÊúàÂà•ÂèéÁ©´Èáè„Éá„Éº„Çø
    const harvestAnalysis = Object.keys(reportsData.harvestByMonth || {}).length > 0
      ? Object.entries(reportsData.harvestByMonth).map(([month, amount]) => ({
          label: month,
          value: Math.round((amount as number) * 10) / 10,
          color: 'bg-green-600'
        }))
      : []

    // „Ç≥„Çπ„ÉàÂàÜÊûê„Éá„Éº„Çø
    const costAnalysis = Object.keys(reportsData.costByType || {}).length > 0
      ? Object.entries(reportsData.costByType).map(([type, amount]) => ({
          label: type,
          value: Math.round(amount as number),
          color: 'bg-blue-600'
        }))
      : []

    // ‰ΩúÊ•≠È†ªÂ∫¶„Éá„Éº„Çø
    const workFrequencyData = Object.keys(reportsData.workFrequency || {}).length > 0
      ? Object.entries(reportsData.workFrequency).map(([type, count]) => ({
          label: type,
          value: count as number,
          color: 'bg-purple-600'
        }))
      : []

    // ÂÆüÈöõ„ÅÆÁ∑èÊ†ΩÂüπÈù¢Á©ç„ÇíË®àÁÆó
    const totalArea = vegetablesData && vegetablesData.length > 0
      ? vegetablesData.reduce((sum: number, veg: any) => sum + (veg.area_size || 0), 0)
      : 300 // „Éá„Éï„Ç©„É´„ÉàÂÄ§

    // „Çµ„Éû„É™„ÉºÊÉÖÂ†±ÔºàÂÆü„Éá„Éº„Çø„ÅÆ„ÅøÔºâ
    const summary = {
      total_revenue: Math.round(reportsData.totalRevenue || 0),
      total_cost: Math.round(reportsData.totalCost || 0),
      profit_margin: Math.round((reportsData.profitMargin || 0) * 10) / 10,
      total_harvest: Math.round((reportsData.totalHarvest || 0) * 10) / 10,
      total_work_hours: Math.round((reportsData.totalWorkHours || 0) * 10) / 10,
      avg_yield_per_sqm: reportsData.totalHarvest && reportsData.totalHarvest > 0 && totalArea > 0
        ? Math.round((reportsData.totalHarvest / totalArea) * 10) / 10
        : 0,
      active_plots: reportsData.activePlots || 0,
      completed_harvests: reportsData.completedHarvests || 0,
      efficiency_score: Math.min(100, Math.max(0,
        Math.round(75 + (reportsData.profitMargin || 0) / 5)
      ))
    }

    return {
      summary,
      dataQuality: reportsData.dataQuality || {
        incomeSource: 'none',
        expenseSource: 'none',
        reliability: 'low'
      },
      harvest_analysis: harvestAnalysis,
      cost_analysis: costAnalysis,
      efficiency_trends: [], // ÂÆü„Éá„Éº„Çø„Åã„ÇâÁîüÊàê„Åï„Çå„ÇãÂ†¥Âêà„ÅÆ„ÅøË®≠ÂÆö
      seasonal_performance: [], // ÂÆü„Éá„Éº„Çø„Åã„ÇâÁîüÊàê„Åï„Çå„ÇãÂ†¥Âêà„ÅÆ„ÅøË®≠ÂÆö
      vegetable_performance: reportsData.vegetablePerformance || [],
      recent_activities: reportsData.recentActivities || [],
      work_frequency: workFrequencyData
    }
  }

  // ÂàÜÊûê„Éá„Éº„Çø„Çí„Éû„Éº„Ç∏Ôºà„Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÇíÁ¢∫‰øùÔºâ
  const mergeAnalyticsData = (baseData: AnalyticsData, reportsData: any) => {
    if (!reportsData) return baseData

    // ÊúàÂà•ÂèéÁ©´Èáè„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàÂÆü„Éá„Éº„ÇøÂÑ™ÂÖàÔºâ
    const updatedHarvestAnalysis = Object.keys(reportsData.harvestByMonth).length > 0
      ? Object.entries(reportsData.harvestByMonth).map(([month, amount]) => ({
          label: month,
          value: Math.round((amount as number) * 10) / 10, // Â∞èÊï∞ÁÇπ‰ª•‰∏ã1Ê°Å„Å´‰∏∏„ÇÅ
          color: 'bg-green-600'
        }))
      : baseData.harvest_analysis

    // „Ç≥„Çπ„ÉàÂàÜÊûê„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàÂÆü„Éá„Éº„ÇøÂÑ™ÂÖàÔºâ
    const updatedCostAnalysis = Object.keys(reportsData.costByType).length > 0
      ? Object.entries(reportsData.costByType).map(([type, amount]) => ({
          label: type,
          value: Math.round(amount as number), // ÂÜÜÂçò‰Ωç„ÅØÊï¥Êï∞„Å´‰∏∏„ÇÅ
          color: 'bg-blue-600'
        }))
      : baseData.cost_analysis

    // ‰ΩúÊ•≠È†ªÂ∫¶„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàÂÆü„Éá„Éº„Çø„ÅÆ„ÅøÔºâ
    const workFrequencyData = Object.keys(reportsData.workFrequency || {}).length > 0
      ? Object.entries(reportsData.workFrequency).map(([type, count]) => ({
          label: type,
          value: count as number,
          color: 'bg-purple-600'
        }))
      : [] // Á©∫ÈÖçÂàó„ÇíËøî„Åô

    // ÂÆüÈöõ„ÅÆÁ∑èÊ†ΩÂüπÈù¢Á©ç„ÇíË®àÁÆó
    const totalArea = vegetablesData && vegetablesData.length > 0
      ? vegetablesData.reduce((sum: number, veg: any) => sum + (veg.area_size || 0), 0)
      : 300 // „Éá„Éï„Ç©„É´„ÉàÂÄ§

    // „Çµ„Éû„É™„ÉºÊÉÖÂ†±„ÅÆÊõ¥Êñ∞ÔºàÊï∞ÂÄ§„ÅÆÊï¥ÂêàÊÄß„Çí‰øùË®ºÔºâ
    const updatedSummary = {
      ...baseData.summary,
      total_revenue: Math.round(reportsData.totalRevenue || baseData.summary.total_revenue),
      total_cost: Math.round(reportsData.totalCost || baseData.summary.total_cost),
      profit_margin: Math.round((reportsData.profitMargin || baseData.summary.profit_margin) * 10) / 10,
      total_harvest: Math.round((reportsData.totalHarvest || baseData.summary.total_harvest) * 10) / 10,
      total_work_hours: Math.round((reportsData.totalWorkHours || 0) * 10) / 10, // Á∑è‰ΩúÊ•≠ÊôÇÈñì„ÇíËøΩÂä†
      avg_yield_per_sqm: reportsData.totalHarvest && totalArea > 0
        ? Math.round((reportsData.totalHarvest / totalArea) * 10) / 10 // ÂÆüÈöõ„ÅÆÈù¢Á©ç„ÅßË®àÁÆó
        : baseData.summary.avg_yield_per_sqm,
      efficiency_score: Math.min(100, Math.max(60,
        Math.round(75 + (reportsData.profitMargin || 0) / 5)
      )) // Âà©ÁõäÁéá„Éô„Éº„Çπ„ÅÆÂãïÁöÑ„Çπ„Ç≥„Ç¢
    }

    return {
      ...baseData,
      summary: updatedSummary,
      dataQuality: reportsData.dataQuality || baseData.dataQuality,
      harvest_analysis: updatedHarvestAnalysis,
      cost_analysis: updatedCostAnalysis,
      vegetable_performance: reportsData.vegetablePerformance && reportsData.vegetablePerformance.length > 0
        ? reportsData.vegetablePerformance
        : baseData.vegetable_performance,
      recent_activities: reportsData.recentActivities && reportsData.recentActivities.length > 0
        ? reportsData.recentActivities
        : baseData.recent_activities,
      // Êñ∞„Åó„ÅÑ‰ΩúÊ•≠È¢ëÂ∫¶„Éá„Éº„Çø„ÇíËøΩÂä†
      work_frequency: workFrequencyData
    }
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('ja-JP', { 
      style: 'currency', 
      currency: 'JPY',
      minimumFractionDigits: 0 
    }).format(amount)
  }

  const formatNumber = (num: number, decimals = 1) => {
    return new Intl.NumberFormat('ja-JP', { 
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals 
    }).format(num)
  }

  const getPerformanceColor = (status: string) => {
    const colors = {
      excellent: 'bg-green-100 text-green-700 border-green-200',
      good: 'bg-blue-100 text-blue-700 border-blue-200',
      average: 'bg-yellow-100 text-yellow-700 border-yellow-200',
      poor: 'bg-red-100 text-red-700 border-red-200'
    }
    return colors[status as keyof typeof colors] || colors.average
  }

  const getPerformanceLabel = (status: string) => {
    const labels = {
      excellent: 'ÂÑ™ÁßÄ',
      good: 'ËâØÂ•Ω',
      average: 'Âπ≥Âùá',
      poor: 'Ë¶ÅÊîπÂñÑ'
    }
    return labels[status as keyof typeof labels] || 'Âπ≥Âùá'
  }


  // Ë™çË®º„Ç®„É©„Éº„ÅÆË°®Á§∫
  if (authError) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <AlertTriangle className="w-12 h-12 mx-auto mb-4 text-red-400" />
          <p className="text-red-600 text-lg font-medium mb-2">Ë™çË®º„Ç®„É©„Éº</p>
          <p className="text-gray-500 text-sm mb-4">{authError}</p>
          <Button onClick={() => window.location.reload()} variant="outline">
            ÂÜçË™≠„ÅøËæº„Åø
          </Button>
        </div>
      </div>
    )
  }

  // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÔºàcompanyId„ÇíÂæÖ„Å£„Å¶„ÅÑ„ÇãÁä∂ÊÖã„ÇÇÂê´„ÇÄÔºâ
  if (loading || !companyId) {
    return (
      <div className="space-y-6">
        <div className="h-8 bg-gray-200 rounded animate-pulse" />
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {[...Array(8)].map((_, i) => (
            <div key={i} className="h-32 bg-gray-200 rounded-lg animate-pulse" />
          ))}
        </div>
        {!companyId && (
          <div className="text-center text-gray-500 text-sm">
            Ë™çË®ºÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÅÑ„Åæ„Åô...
          </div>
        )}
      </div>
    )
  }

  if (!data) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <AlertTriangle className="w-12 h-12 mx-auto mb-4 text-gray-400" />
          <p className="text-gray-600 text-lg font-medium mb-2">ÁôªÈå≤ÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
          <p className="text-gray-500 text-sm">ÈáéËèú„ÅÆÁôªÈå≤„ÇÑ‰ΩúÊ•≠Ë®òÈå≤„Çí‰ΩúÊàê„Åô„Çã„Å®„ÄÅÂàÜÊûê„Éá„Éº„Çø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
          <p className="text-xs text-gray-400 mt-2">‰ΩøÁî®‰∏≠„ÅÆ‰ºöÁ§æID: {companyId}</p>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* „Éò„ÉÉ„ÉÄ„Éº */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">„É¨„Éù„Éº„Éà„ÉªÂàÜÊûê</h1>
          <p className="text-gray-600">Ê†ΩÂüπ„Éá„Éº„Çø„ÇíÂàÜÊûê„Åó„Å¶ÁµåÂñ∂„ÇíÊúÄÈÅ©Âåñ„Åó„Åæ„Åó„Çá„ÅÜ</p>
        </div>
        
        <div className="flex items-center gap-3">
          <Select value={selectedVegetable} onValueChange={setSelectedVegetable}>
            <SelectTrigger className="w-48">
              <SelectValue placeholder="ÈáéËèú„ÇíÈÅ∏Êäû" />
            </SelectTrigger>
            <SelectContent>
              {vegetableOptions.map((option) => (
                <SelectItem key={option.id} value={option.id}>
                  {option.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          
          <div className="flex items-center gap-2">
            <div className="text-xs text-gray-500">
              ÊúÄÁµÇÊõ¥Êñ∞: {lastUpdated.toLocaleTimeString('ja-JP')}
            </div>
            <Button
              variant={autoRefresh ? 'default' : 'outline'}
              size="sm"
              onClick={() => setAutoRefresh(!autoRefresh)}
            >
              <RefreshCw className={`w-4 h-4 mr-2 ${autoRefresh ? 'animate-spin' : ''}`} />
              Ëá™ÂãïÊõ¥Êñ∞
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={fetchAnalyticsData}
            >
              <RefreshCw className="w-4 h-4 mr-2" />
              ÊâãÂãïÊõ¥Êñ∞
            </Button>
          </div>
        </div>
      </div>

      {/* ‰∏äÊÆµ: Âü∫Êú¨ÊÉÖÂ†±„Ç´„Éº„Éâ - 4Âàó„É¨„Ç§„Ç¢„Ç¶„Éà */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        {/* 1. ÁôªÈå≤ÈáéËèúÊï∞ */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-green-50 to-emerald-100 border-green-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <p className="text-sm text-green-700 font-medium mb-2">ÁôªÈå≤ÈáéËèúÊï∞</p>
                <p className="text-2xl font-bold text-green-900">
                  {availableVegetables.length}
                  <span className="text-base ml-2">ÂìÅÁ®Æ</span>
                </p>
                <p className="text-xs text-green-600 flex items-center mt-2">
                  <Sprout className="w-3 h-3 mr-1" />
                  {selectedVegetable === 'all' ? 'ÂÖ®ÈáéËèú' : 'ÈÅ∏Êäû‰∏≠'}
                </p>
              </div>
              <div className="relative">
                <Sprout className="w-10 h-10 text-green-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center transition-transform duration-300 group-hover:scale-125">
                  <span className="text-xs text-white font-bold">{availableVegetables.length}</span>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* 2. Á∑èÊ†ΩÂüπÈù¢Á©ç */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-blue-50 to-sky-100 border-blue-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <p className="text-sm text-blue-700 font-medium mb-2">Á∑èÊ†ΩÂüπÈù¢Á©ç</p>
                <p className="text-2xl font-bold text-blue-900">
                  {formatNumber(
                    vegetablesData && vegetablesData.length > 0
                      ? vegetablesData.reduce((sum: number, veg: any) => {
                          return sum + (veg.area_size || 0)
                        }, 0)
                      : 0,
                    0
                  )}
                  <span className="text-base ml-2">„é°</span>
                </p>
                <p className="text-xs text-blue-600 flex items-center mt-2">
                  <MapPin className="w-3 h-3 mr-1" />
                  {vegetablesData && vegetablesData.length > 0
                    ? vegetablesData.filter((veg: any) => veg.area_size > 0).length
                    : 0} ÈáéËèú
                </p>
              </div>
              <div className="relative">
                <MapPin className="w-10 h-10 text-blue-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center transition-transform duration-300 group-hover:scale-125">
                  <span className="text-xs text-white font-bold">„é°</span>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* 3. Á∑èÂèéÁ©´ÈáèÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-blue-50 to-cyan-100 border-blue-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <p className="text-sm text-blue-700 font-medium mb-2">Á∑èÂèéÁ©´ÈáèÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ</p>
                <p className="text-2xl font-bold text-blue-900">{formatNumber(data.summary.total_harvest, 0)}kg</p>
                <p className="text-xs text-blue-600 flex items-center mt-2">
                  <Sprout className="w-3 h-3 mr-1" />
                  Âπ≥Âùá {formatNumber(data.summary.avg_yield_per_sqm)}kg/„é°
                </p>
              </div>
              <div className="relative">
                <Sprout className="w-10 h-10 text-blue-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center transition-transform duration-300 group-hover:scale-125">
                  <span className="text-xs text-white font-bold">kg</span>
                </div>
              </div>
            </div>
            <div className="absolute bottom-0 right-0 opacity-10 transition-opacity duration-300 group-hover:opacity-20">
              <Award className="w-20 h-20 text-blue-800" />
            </div>
          </CardContent>
        </Card>

        {/* 4. Á∑è‰ΩúÊ•≠ÊôÇÈñìÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-amber-50 to-yellow-100 border-amber-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <p className="text-sm text-amber-700 font-medium mb-2">Á∑è‰ΩúÊ•≠ÊôÇÈñìÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ</p>
                <p className="text-2xl font-bold text-amber-900">{formatNumber(data.summary.total_work_hours, 1)}h</p>
                <p className="text-xs text-amber-600 flex items-center mt-2">
                  <Clock className="w-3 h-3 mr-1" />
                  ‰∫∫ÊôÇ„Éô„Éº„Çπ
                </p>
              </div>
              <div className="relative">
                <Clock className="w-10 h-10 text-amber-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center transition-transform duration-300 group-hover:scale-125">
                  <span className="text-xs text-white font-bold">h</span>
                </div>
              </div>
            </div>
            <div className="absolute bottom-0 right-0 opacity-10 transition-opacity duration-300 group-hover:opacity-20">
              <Activity className="w-20 h-20 text-amber-800" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* ‰∏ãÊÆµ: ÈáëËûçKPI„Ç´„Éº„Éâ - 4Âàó„É¨„Ç§„Ç¢„Ç¶„Éà */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {/* 5. Á∑èÂèéÂÖ•ÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-emerald-50 to-green-100 border-emerald-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <div className="flex items-center gap-2 mb-2">
                  <p className="text-sm text-emerald-700 font-medium">Á∑èÂèéÂÖ•ÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ</p>
                  {data.dataQuality?.incomeSource === 'accounting' && (
                    <Badge className="text-xs bg-green-500 text-white px-2 py-0.5">ÂÆüÁ∏æ</Badge>
                  )}
                  {data.dataQuality?.incomeSource === 'estimated' && (
                    <Badge className="text-xs bg-yellow-500 text-white px-2 py-0.5">Êé®ÂÆö</Badge>
                  )}
                </div>
                <p className="text-2xl font-bold text-emerald-900">{formatCurrency(data.summary.total_revenue)}</p>
                <p className="text-xs text-emerald-600 flex items-center mt-2">
                  <TrendingUp className="w-3 h-3 mr-1" />
                  {data.dataQuality?.incomeSource === 'accounting' ? '‰ºöË®àÈÄ£Êê∫Ê∏à' : '„Éè„Éº„Éô„Çπ„ÉàÊé®ÂÆö'}
                </p>
              </div>
              <div className="relative">
                <DollarSign className="w-10 h-10 text-emerald-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center transition-transform duration-300 group-hover:scale-125">
                  <span className="text-xs text-white font-bold">¬•</span>
                </div>
              </div>
            </div>
            <div className="absolute bottom-0 right-0 opacity-10 transition-opacity duration-300 group-hover:opacity-20">
              <Sprout className="w-20 h-20 text-green-800" />
            </div>
          </CardContent>
        </Card>

        {/* 6. Á∑èÊîØÂá∫ÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-red-50 to-orange-100 border-red-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <div className="flex items-center gap-2 mb-2">
                  <p className="text-sm text-red-700 font-medium">Á∑èÊîØÂá∫ÔºàÁõ¥Ëøë12„Ç´ÊúàÔºâ</p>
                  {data.dataQuality?.expenseSource === 'accounting' && (
                    <Badge className="text-xs bg-green-500 text-white px-2 py-0.5">ÂÆüÁ∏æ</Badge>
                  )}
                  {data.dataQuality?.expenseSource === 'estimated' && (
                    <Badge className="text-xs bg-yellow-500 text-white px-2 py-0.5">Êé®ÂÆö</Badge>
                  )}
                </div>
                <p className="text-2xl font-bold text-red-900">{formatCurrency(data.summary.total_cost)}</p>
                <p className="text-xs text-red-600 flex items-center mt-2">
                  <TrendingDown className="w-3 h-3 mr-1" />
                  {data.dataQuality?.expenseSource === 'accounting' ? '‰ºöË®àÈÄ£Êê∫Ê∏à' : '‰ΩúÊ•≠ÊôÇÈñìÊé®ÂÆö'}
                </p>
              </div>
              <div className="relative">
                <DollarSign className="w-10 h-10 text-red-600 opacity-90 transform rotate-180 transition-transform duration-300 group-hover:rotate-[192deg] group-hover:scale-110" />
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center transition-transform duration-300 group-hover:scale-125">
                  <span className="text-xs text-white font-bold">-</span>
                </div>
              </div>
            </div>
            <div className="absolute bottom-0 right-0 opacity-10 transition-opacity duration-300 group-hover:opacity-20">
              <Target className="w-20 h-20 text-red-800" />
            </div>
          </CardContent>
        </Card>

        {/* 7. Á¥îÂà©Áõä */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-blue-50 to-sky-100 border-blue-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <div className="flex items-center gap-2 mb-2">
                  <p className="text-sm text-blue-700 font-medium">Á¥îÂà©Áõä</p>
                  {data?.dataQuality && (
                    <Badge className="text-xs bg-blue-500 text-white px-1 py-0">
                      {data.dataQuality.reliability === 'high' ? 'ÂÆü' :
                       data.dataQuality.reliability === 'medium' ? 'Ê∑∑' : 'Êé®'}
                    </Badge>
                  )}
                </div>
                <div className="space-y-1">
                  <div className="flex items-center justify-between">
                    <span className="text-2xl font-bold text-blue-900">
                      ¬•{data ? formatNumber((data.summary.total_revenue || 0) - (data.summary.total_cost || 0)) : '0'}
                    </span>
                  </div>
                  <p className="text-xs text-blue-600 flex items-center">
                    <DollarSign className="w-3 h-3 mr-1" />
                    Âà©ÁõäÁéá: {data ? formatNumber(data.summary.profit_margin || 0, 1) : '0'}%
                  </p>
                </div>
              </div>
              <div className="relative">
                {data && ((data.summary.total_revenue || 0) - (data.summary.total_cost || 0)) >= 0 ? (
                  <TrendingUp className="w-10 h-10 text-green-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                ) : (
                  <TrendingDown className="w-10 h-10 text-red-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                )}
              </div>
            </div>
          </CardContent>
        </Card>

        {/* 8. ÊäïË≥áÂèéÁõäÁéáÔºàROIÔºâ */}
        <Card className="relative overflow-hidden bg-gradient-to-br from-purple-50 to-indigo-100 border-purple-200 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:-translate-y-1 group">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div className="relative z-10">
                <div className="flex items-center gap-2 mb-2">
                  <p className="text-sm text-purple-700 font-medium">ÊäïË≥áÂèéÁõäÁéá</p>
                  <Badge className="text-xs bg-purple-500 text-white px-1 py-0">ROI</Badge>
                </div>
                <div className="space-y-1">
                  <div className="flex items-center justify-between">
                    <span className="text-2xl font-bold text-purple-900">
                      {data && data.summary.total_cost > 0
                        ? `${(((data.summary.total_revenue - data.summary.total_cost) / data.summary.total_cost) * 100).toFixed(1)}%`
                        : 'N/A'}
                    </span>
                  </div>
                  <div className="text-xs text-purple-600">
                    <div className="flex justify-between">
                      <span>ÂèéÁõä</span>
                      <span className="font-medium">
                        {data ? `${(data.summary.total_revenue / 10000).toFixed(0)}‰∏áÂÜÜ` : 'N/A'}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span>„Ç≥„Çπ„Éà</span>
                      <span className="font-medium">
                        {data ? `${(data.summary.total_cost / 10000).toFixed(0)}‰∏áÂÜÜ` : 'N/A'}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div className="relative">
                {data && data.summary.total_revenue > data.summary.total_cost ? (
                  <TrendingUp className="w-10 h-10 text-green-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                ) : (
                  <TrendingDown className="w-10 h-10 text-red-600 opacity-90 transition-transform duration-300 group-hover:rotate-12 group-hover:scale-110" />
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      </div>


      {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çø„Éñ - ÈáëËûçÁ≥ª„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Éá„Ç∂„Ç§„É≥ */}
      <Tabs defaultValue="performance" className="space-y-6">
          <TabsList className="grid w-full grid-cols-3 gap-2 bg-transparent p-1">
            <TabsTrigger
              value="performance"
              className="
                relative px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-200
                data-[state=inactive]:bg-white data-[state=inactive]:text-gray-600
                data-[state=inactive]:hover:bg-gray-50 data-[state=inactive]:hover:text-gray-800
                data-[state=inactive]:border data-[state=inactive]:border-gray-200
                data-[state=active]:bg-gradient-to-r data-[state=active]:from-slate-700 data-[state=active]:to-slate-800
                data-[state=active]:text-white data-[state=active]:shadow-md
                data-[state=active]:border-0
                group
              "
            >
              <div className="flex items-center justify-center gap-2">
                <Activity className="w-4 h-4" />
                <span>„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</span>
              </div>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-500 scale-x-0 group-data-[state=active]:scale-x-100 transition-transform duration-200" />
            </TabsTrigger>

            <TabsTrigger
              value="harvest-revenue"
              className="
                relative px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-200
                data-[state=inactive]:bg-white data-[state=inactive]:text-gray-600
                data-[state=inactive]:hover:bg-gray-50 data-[state=inactive]:hover:text-gray-800
                data-[state=inactive]:border data-[state=inactive]:border-gray-200
                data-[state=active]:bg-gradient-to-r data-[state=active]:from-slate-700 data-[state=active]:to-slate-800
                data-[state=active]:text-white data-[state=active]:shadow-md
                data-[state=active]:border-0
                group
              "
            >
              <div className="flex items-center justify-center gap-2">
                <DollarSign className="w-4 h-4" />
                <span>ÂèéÁõä„Ç≥„Çπ„ÉàÂàÜÊûê</span>
              </div>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-500 scale-x-0 group-data-[state=active]:scale-x-100 transition-transform duration-200" />
            </TabsTrigger>

            <TabsTrigger
              value="worklog-cost"
              className="
                relative px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-200
                data-[state=inactive]:bg-white data-[state=inactive]:text-gray-600
                data-[state=inactive]:hover:bg-gray-50 data-[state=inactive]:hover:text-gray-800
                data-[state=inactive]:border data-[state=inactive]:border-gray-200
                data-[state=active]:bg-gradient-to-r data-[state=active]:from-slate-700 data-[state=active]:to-slate-800
                data-[state=active]:text-white data-[state=active]:shadow-md
                data-[state=active]:border-0
                group
              "
            >
              <div className="flex items-center justify-center gap-2">
                <Clock className="w-4 h-4" />
                <span>‰ΩúÊ•≠ÊôÇÈñìÂàÜÊûê</span>
              </div>
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-amber-500 scale-x-0 group-data-[state=active]:scale-x-100 transition-transform duration-200" />
            </TabsTrigger>
          </TabsList>

        {/* „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Çø„Éñ */}
        <TabsContent value="performance" className="space-y-6">
          {/* AIÁöÑÊ¥ûÂØüÊ©üËÉΩ‰ªò„Åç‰ΩúÊ•≠Á®ÆÈ°ûÂà•Áµ±Âêà„É¨„Éù„Éº„Éà */}
          <WorkTypeAnalysisReport companyId={companyId || ''} selectedVegetable={selectedVegetable} />
        </TabsContent>

        {/* ‰ΩúÊ•≠ÊôÇÈñìÂàÜÊûê„Çø„Éñ */}
        <TabsContent value="worklog-cost" className="space-y-6">
          {/* AI‰∫àÊ∏¨‰ΩúÊ•≠ÊôÇÈñìÂàÜÊûê„ÉÅ„É£„Éº„Éà */}
          <MonthlyWorkHoursChart companyId={companyId || ''} selectedVegetable={selectedVegetable} />
        </TabsContent>

        {/* ÂèéÁõä„Ç≥„Çπ„ÉàÂàÜÊûê„Çø„Éñ */}
        <TabsContent value="harvest-revenue" className="space-y-6">
          {/* ÊúàÊ¨°„Ç≠„É£„ÉÉ„Ç∑„É•„Éï„É≠„ÉºÊé®Áßª„Ç∞„É©„Éï */}
          <MonthlyCashflowChart companyId={companyId || ''} selectedVegetable={selectedVegetable} />
          
          {/* ÂèéÊîØÊßãÈÄ†√óÂäπÁéáÊÄß√óÊàêÈï∑ÂàÜÊûê„ÉÅ„É£„Éº„Éà */}
          <FinancialPerformanceChart companyId={companyId || ''} selectedVegetable={selectedVegetable} />
        </TabsContent>

      </Tabs>

    </div>
  )
}