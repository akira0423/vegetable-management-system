'use client'

import React, { useState, useMemo, useRef, useCallback, useEffect } from 'react'
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  LineElement,
  PointElement,
  Title,
  Tooltip,
  Legend,
  ChartOptions,
  InteractionItem,
  ChartEvent
} from 'chart.js'
import { Bar, getElementAtEvent } from 'react-chartjs-2'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Calendar } from '@/components/ui/calendar'
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogPortal, DialogOverlay } from '@/components/ui/dialog'
import * as DialogPrimitive from '@radix-ui/react-dialog'
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible'
import { cn } from '@/lib/utils/index'
import { CalendarIcon, Clock, TrendingUp, TrendingDown, Eye, X, Zap, Target, Award, ChevronRight, Sprout } from 'lucide-react'
import { format, addMonths, subMonths } from 'date-fns'
import { ja } from 'date-fns/locale'
import { createClient } from '@supabase/supabase-js'
import type { Database, WeatherRecord } from '@/types/database'

// Chart.jsã®ç™»éŒ²
ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  LineElement,
  PointElement,
  Title,
  Tooltip,
  Legend
)

interface WorkHoursData {
  month: string
  year: number
  month_num: number
  work_types: {
    [key: string]: {
      total_hours: number
      revenue_per_hour: number
      cost_per_hour: number
      roi_per_hour: number
      efficiency_score: number
      work_count: number
      details: WorkDetail[]
    }
  }
  monthly_total_hours: number
  monthly_avg_efficiency: number
  monthly_total_revenue: number
  monthly_total_cost: number
  // ğŸŒ¡ï¸ğŸ’§ æ°—è±¡ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
  weather_data?: {
    temperature: number  // å¹³å‡æ°—æ¸©ï¼ˆÂ°Cï¼‰
    humidity: number     // å¹³å‡æ¹¿åº¦ï¼ˆ%ï¼‰
    temperature_range: {
      min: number
      max: number
    }
    humidity_range: {
      min: number
      max: number
    }
  }
  ai_predictions?: {
    predicted_hours: number
    efficiency_trend: 'improving' | 'stable' | 'declining'
    optimization_score: number
    suggestions: string[]
  }
  benchmarks?: {
    industry_average_hours: number
    top_performers_hours: number
    efficiency_percentile: number
  }
}

interface WorkDetail {
  id: string
  work_type: string
  work_date: string
  duration_hours: number
  revenue_generated: number
  cost_incurred: number
  efficiency_rating: 'excellent' | 'good' | 'average' | 'poor'
  description?: string
}

interface MonthlyWorkHoursChartProps {
  companyId: string
  selectedVegetable?: string
}

// ğŸŒ¡ï¸ğŸ’§ æ°—è±¡ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³
interface WeatherDisplayOptions {
  showTemperature: boolean
  showHumidity: boolean
}

// ä½œæ¥­ç¨®åˆ¥ã®è‰²å®šç¾©ï¼ˆAIåŠ¹ç‡Ã—ROIæœ€é©åŒ–ãƒ†ãƒ¼ãƒï¼‰
const WORK_TYPE_COLORS = {
  seeding: '#6366f1',      // ã‚¤ãƒ³ãƒ‡ã‚£ã‚´ - æ’­ç¨®ï¼ˆè¨ˆç”»æ€§ï¼‰
  planting: '#8b5cf6',     // ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ - å®šæ¤ï¼ˆå®Ÿè¡ŒåŠ›ï¼‰
  fertilizing: '#f59e0b',  // ã‚¢ãƒ³ãƒãƒ¼ - æ–½è‚¥ï¼ˆæŠ•è³‡åŠ¹æœï¼‰
  watering: '#06b6d4',     // ã‚·ã‚¢ãƒ³ - çŒæ°´ï¼ˆæŒç¶šæ€§ï¼‰
  weeding: '#ef4444',      // ãƒ¬ãƒƒãƒ‰ - é™¤è‰ï¼ˆåŠ¹ç‡æ€§ï¼‰
  pruning: '#a855f7',      // ãƒ‘ãƒ¼ãƒ—ãƒ« - æ•´æï¼ˆç²¾å¯†æ€§ï¼‰
  harvesting: '#10b981',   // ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ - åç©«ï¼ˆåç›Šæ€§ï¼‰
  other: '#6b7280'         // ã‚°ãƒ¬ãƒ¼ - ãã®ä»–
}

const WORK_TYPE_LABELS = {
  seeding: 'æ’­ç¨®',
  planting: 'å®šæ¤', 
  fertilizing: 'æ–½è‚¥',
  watering: 'çŒæ°´',
  weeding: 'é™¤è‰',
  pruning: 'æ•´æ',
  harvesting: 'åç©«',
  other: 'ãã®ä»–'
}

// ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¸æ³•è¨ˆç®—ã®å‹å®šç¾©
interface ResponsiveDimensions {
  monthCount: number
  barWidth: number
  categoryPercentage: number
  barPercentage: number
  fontSize: number
  labelRotation: number
}

// ã‚«ã‚¹ã‚¿ãƒ LargeDialogContent
interface LargeDialogContentProps extends React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content> {
  width?: string
  height?: string
  children?: React.ReactNode
  title?: string
}

function LargeDialogContent({
  className,
  children,
  width = "1200px",
  height = "900px",
  title = "ä½œæ¥­æ™‚é–“è©³ç´°åˆ†æ",
  ...props
}: LargeDialogContentProps) {
  return (
    <DialogPortal>
      <DialogOverlay />
      <DialogPrimitive.Content
        className={cn(
          "fixed top-[50%] left-[50%] z-50 translate-x-[-50%] translate-y-[-50%]",
          "data-[state=open]:animate-in data-[state=closed]:animate-out",
          "data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
          "data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95",
          "grid gap-4 rounded-lg border p-6 shadow-lg duration-200",
          "bg-white border-gray-300 shadow-xl overflow-auto",
          className
        )}
        style={{ 
          width, 
          height, 
          maxWidth: '98vw', 
          maxHeight: '98vh' 
        }}
        {...props}
      >
        <DialogPrimitive.Title className="sr-only">
          {title}
        </DialogPrimitive.Title>
        {children}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

export default function MonthlyWorkHoursChart({ companyId, selectedVegetable = 'all' }: MonthlyWorkHoursChartProps) {
  // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
  const supabase = createClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
  const [startMonth, setStartMonth] = useState<Date>(new Date(new Date().getFullYear(), 0, 1))
  const [calendarOpen, setCalendarOpen] = useState(false)
  const [yearMonthPickerOpen, setYearMonthPickerOpen] = useState(false)
  const [selectedYear, setSelectedYear] = useState<number>(new Date().getFullYear())
  const [selectedMonthNum, setSelectedMonthNum] = useState<number>(1)
  const [displayPeriod, setDisplayPeriod] = useState<1 | 2 | 3>(1)
  const [workHoursData, setWorkHoursData] = useState<WorkHoursData[]>([])
  const [previousYearData, setPreviousYearData] = useState<WorkHoursData[]>([])
  const [loading, setLoading] = useState(false)
  const [selectedMonth, setSelectedMonth] = useState<WorkHoursData | null>(null)
  const [drilldownOpen, setDrilldownOpen] = useState(false)
  const [showComparison, setShowComparison] = useState(true)
  const [showAIInsights, setShowAIInsights] = useState(true)
  // ç´¯ç©ä½œæ¥­æ™‚é–“ç·šã®åˆ¶å¾¡çŠ¶æ…‹
  const [showCumulativeWorkTime, setShowCumulativeWorkTime] = useState(true)
  const [containerWidth, setContainerWidth] = useState(0)
  const [lastUpdated, setLastUpdated] = useState(new Date())
  // ä½œæ¥­ç¨®åˆ¥ãƒ»æœŸé–“åˆè¨ˆæ™‚é–“ã®å±•é–‹çŠ¶æ…‹
  const [isWorkTypeTotalsOpen, setIsWorkTypeTotalsOpen] = useState(true)
  
  // ğŸŒ¡ï¸ğŸ’§ æ°—è±¡ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºçŠ¶æ…‹
  const [weatherDisplayOptions, setWeatherDisplayOptions] = useState<WeatherDisplayOptions>({
    showTemperature: false,
    showHumidity: false
  })
  
  const chartRef = useRef<ChartJS<'bar'>>(null)
  const containerRef = useRef<HTMLDivElement>(null)
  const [chartDimensions, setChartDimensions] = useState({ left: 0, right: 0, width: 0 })

  // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¸æ³•è¨ˆç®—
  const calculateResponsiveDimensions = useCallback((period: number, containerWidth: number): ResponsiveDimensions => {
    const monthCount = period * 12
    const availableWidth = containerWidth - 90
    const idealBarWidth = availableWidth / monthCount
    
    const barWidth = Math.max(25, Math.min(80, idealBarWidth))
    const categoryPercentage = barWidth > 50 ? 0.9 : 0.95
    const barPercentage = barWidth > 50 ? 0.8 : barWidth > 35 ? 0.85 : 0.9
    const fontSize = barWidth > 50 ? 12 : barWidth > 35 ? 11 : 10
    const labelRotation = barWidth < 40 ? 45 : 0
    
    return {
      monthCount,
      barWidth,
      categoryPercentage,
      barPercentage,
      fontSize,
      labelRotation
    }
  }, [])

  // ã‚³ãƒ³ãƒ†ãƒŠå¹…ã®ç›£è¦–
  useEffect(() => {
    const updateContainerWidth = () => {
      if (containerRef.current) {
        setContainerWidth(containerRef.current.offsetWidth)
      }
    }

    updateContainerWidth()
    window.addEventListener('resize', updateContainerWidth)
    return () => window.removeEventListener('resize', updateContainerWidth)
  }, [])

  // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®šã®è¨ˆç®—
  const responsiveDimensions = useMemo(() => 
    calculateResponsiveDimensions(displayPeriod, containerWidth), 
    [displayPeriod, containerWidth, calculateResponsiveDimensions]
  )

  // Yè»¸ç¯„å›²ã®å‹•çš„è¨ˆç®—ï¼ˆå¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆï¼‰
  const calculateYAxisRange = useCallback((data: WorkHoursData[]) => {
    if (!data || data.length === 0) return {
      min: 0,
      max: 100,
      stepSize: 20,
      tickCount: 6,
      unit: 'hours',
      unitDivisor: 1,
      unitLabel: 'æ™‚é–“'
    }

    const allValues = data.map(d => d.monthly_total_hours)
    const rawMax = Math.max(...allValues, 10)

    // ä¸Šéƒ¨ã«20%ã®ä½™è£•ã‚’æŒãŸã›ã‚‹
    let targetMax = rawMax * 1.2

    // å˜ä½ã®è‡ªå‹•é¸æŠï¼ˆèª­ã¿ã‚„ã™ã•ã‚’é‡è¦–ï¼‰
    let unit = 'hours'
    let unitDivisor = 1
    let unitLabel = 'æ™‚é–“'

    if (targetMax >= 50000) {
      // 5ä¸‡æ™‚é–“ä»¥ä¸Šã¯ã€Œä¸‡æ™‚é–“ã€è¡¨ç¤º
      unit = 'man'
      unitDivisor = 10000
      unitLabel = 'ä¸‡æ™‚é–“'
      targetMax = targetMax / 10000
    } else if (targetMax >= 5000) {
      // 5åƒæ™‚é–“ä»¥ä¸Šã¯ã€Œåƒæ™‚é–“ã€è¡¨ç¤º
      unit = 'sen'
      unitDivisor = 1000
      unitLabel = 'åƒæ™‚é–“'
      targetMax = targetMax / 1000
    }

    // å˜ä½å¤‰æ›å¾Œã®æœ€é©ãªã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚ºå€™è£œ
    const niceSteps = [
      0.1, 0.2, 0.25, 0.5,
      1, 2, 2.5, 5,
      10, 20, 25, 50,
      100, 200, 250, 500,
      1000, 2000, 2500, 5000,
      10000, 20000, 25000, 50000,
      100000
    ]

    // 5ã€œ8å€‹ã®ç›®ç››ã‚Šã«ãªã‚‹æœ€é©ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¦‹ã¤ã‘ã‚‹
    let bestOption = { stepSize: 1, tickCount: 6, max: 6 }
    let minDiff = Infinity

    for (const step of niceSteps) {
      // 5ã€œ8å€‹ã®ç¯„å›²ã§è©¦ã™
      for (let ticks = 5; ticks <= 8; ticks++) {
        const candidateMax = step * (ticks - 1)
        if (candidateMax >= targetMax) {
          const diff = candidateMax - targetMax
          if (diff < minDiff) {
            minDiff = diff
            bestOption = {
              stepSize: step,
              tickCount: ticks,
              max: candidateMax
            }
          }
        }
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
    if (bestOption.max < targetMax) {
      const targetTicks = 6
      const rawStep = targetMax / (targetTicks - 1)
      const step = niceSteps.find(s => s >= rawStep) || rawStep
      bestOption = {
        stepSize: Math.ceil(step),
        tickCount: targetTicks,
        max: Math.ceil(step) * (targetTicks - 1)
      }
    }

    return {
      min: 0,
      max: bestOption.max,
      stepSize: bestOption.stepSize,
      tickCount: bestOption.tickCount,
      unit,
      unitDivisor,
      unitLabel
    }
  }, [])

  // ğŸŒ¡ï¸ğŸ’§ Supabaseã‹ã‚‰æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆwork_reportsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
  const fetchWeatherData = useCallback(async (month: Date): Promise<WorkHoursData['weather_data']> => {
    try {
      const startOfMonth = new Date(month.getFullYear(), month.getMonth(), 1)
      const endOfMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0)
      
      const { data: weatherRecords, error } = await supabase
        .from('work_reports')
        .select('temperature, humidity')
        .eq('company_id', companyId)
        .gte('work_date', startOfMonth.toISOString().split('T')[0])
        .lte('work_date', endOfMonth.toISOString().split('T')[0])
        .not('temperature', 'is', null)
        .not('humidity', 'is', null)

      if (error) {
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆãªã©ã¯é™ã‹ã«ç„¡è¦–
        console.warn('æ°—è±¡ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ')
        return null
      }

      if (!weatherRecords || weatherRecords.length === 0) {
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯nullã‚’è¿”ã™
        return null
      }

      // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆ0ã‚„ç©ºå€¤ã‚’é™¤å¤–ï¼‰
      const validRecords = weatherRecords.filter(record => 
        record.temperature && record.temperature > 0 && 
        record.humidity && record.humidity > 0
      )

      if (validRecords.length === 0) {
        // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯nullã‚’è¿”ã™
        return null
      }

      // æœˆå¹³å‡å€¤ã‚’è¨ˆç®—
      const avgTemp = validRecords.reduce((sum, record) => sum + record.temperature, 0) / validRecords.length
      const avgHumidity = validRecords.reduce((sum, record) => sum + record.humidity, 0) / validRecords.length
      const minTemp = Math.min(...validRecords.map(r => r.temperature))
      const maxTemp = Math.max(...validRecords.map(r => r.temperature))
      const minHumidity = Math.min(...validRecords.map(r => r.humidity))
      const maxHumidity = Math.max(...validRecords.map(r => r.humidity))

      return {
        temperature: Math.round(avgTemp * 10) / 10,
        humidity: Math.round(avgHumidity),
        temperature_range: {
          min: isFinite(minTemp) ? Math.round(minTemp * 10) / 10 : avgTemp - 5,
          max: isFinite(maxTemp) ? Math.round(maxTemp * 10) / 10 : avgTemp + 5
        },
        humidity_range: {
          min: isFinite(minHumidity) ? minHumidity : Math.max(0, avgHumidity - 10),
          max: isFinite(maxHumidity) ? maxHumidity : Math.min(100, avgHumidity + 10)
        }
      }
    } catch (error) {
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«ç„¡è¦–
      console.warn('æ°—è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error)
      return null
    }
  }, [companyId, supabase])

  // AIäºˆæ¸¬ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
  const generateAIPredictions = (monthData: any[], workReports: any[]): WorkHoursData['ai_predictions'] => {
    if (workReports.length === 0) return undefined

    // å¹³å‡ä½œæ¥­æ™‚é–“ã‚’è¨ˆç®—
    const totalHours = workReports.reduce((sum: number, r: any) => sum + (r.duration_hours || 2), 0)
    const avgEfficiency = workReports.reduce((sum: number, r: any) => {
      const revenue = (r.harvest_amount || 0) * (r.expected_price || 0)
      const cost = r.estimated_cost || (r.duration_hours || 2) * 1000 // æ™‚çµ¦1000å††æƒ³å®š
      return sum + (cost > 0 ? revenue / cost : 0)
    }, 0) / workReports.length

    // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æï¼ˆç°¡æ˜“ï¼‰
    let trend: 'improving' | 'stable' | 'declining' = 'stable'
    if (avgEfficiency > 1.2) trend = 'improving'
    else if (avgEfficiency < 0.8) trend = 'declining'

    // æœ€é©åŒ–ã‚¹ã‚³ã‚¢è¨ˆç®—
    const optimizationScore = Math.min(100, Math.max(0, avgEfficiency * 50))

    // AIææ¡ˆç”Ÿæˆ
    const suggestions = []
    if (avgEfficiency < 1.0) {
      suggestions.push('ä½œæ¥­åŠ¹ç‡ã®æ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚ä½œæ¥­æ‰‹é †ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚')
    }
    if (totalHours > 200) {
      suggestions.push('æœˆé–“ä½œæ¥­æ™‚é–“ãŒå¤šã‚ã§ã™ã€‚ä½œæ¥­åˆ†æ•£ã‚„åŠ¹ç‡åŒ–ãƒ„ãƒ¼ãƒ«ã®å°å…¥ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚')
    }
    if (trend === 'declining') {
      suggestions.push('åŠ¹ç‡æ€§ã®ä½ä¸‹å‚¾å‘ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚åŸå› åˆ†æã¨å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚')
    }
    
    return {
      predicted_hours: totalHours * 1.1, // 10%å¢—ã‚’äºˆæ¸¬
      efficiency_trend: trend,
      optimization_score: Math.round(optimizationScore),
      suggestions
    }
  }

  // ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯è¨ˆç®—ï¼ˆæ¥­ç•Œå¹³å‡ãªã©ï¼‰
  const generateBenchmarks = (totalHours: number): WorkHoursData['benchmarks'] => {
    // ä»®ã®æ¥­ç•Œãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã¯å¤–éƒ¨APIã‚„DBã‹ã‚‰å–å¾—ï¼‰
    return {
      industry_average_hours: 180, // æœˆé–“180æ™‚é–“ã‚’æ¥­ç•Œå¹³å‡ã¨ä»®å®š
      top_performers_hours: 150,   // ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼150æ™‚é–“
      efficiency_percentile: totalHours <= 150 ? 90 : totalHours <= 180 ? 70 : totalHours <= 220 ? 50 : 25
    }
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ
  const fetchWorkHoursData = useCallback(async () => {
    if (!companyId) return
    
    setLoading(true)
    try {
      console.log('â° ä½œæ¥­æ™‚é–“ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹:', companyId)
      
      const endMonth = addMonths(startMonth, responsiveDimensions.monthCount - 1)
      const startDate = format(startMonth, 'yyyy-MM-01')
      const endDate = format(endMonth, 'yyyy-MM-dd')
      
      let apiUrl = `/api/reports?company_id=${companyId}&start_date=${startDate}&end_date=${endDate}&limit=1000`
      if (selectedVegetable && selectedVegetable !== 'all') {
        apiUrl += `&vegetable_id=${selectedVegetable}`
      }
      
      // å‰å¹´åŒæœŸã®ãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—
      const previousYearStart = format(subMonths(startMonth, 12), 'yyyy-MM-01')
      const previousYearEnd = format(subMonths(endMonth, 12), 'yyyy-MM-dd')
      let previousYearApiUrl = `/api/reports?company_id=${companyId}&start_date=${previousYearStart}&end_date=${previousYearEnd}&limit=1000`
      if (selectedVegetable && selectedVegetable !== 'all') {
        previousYearApiUrl += `&vegetable_id=${selectedVegetable}`
      }
      
      const [reportsResponse, previousYearResponse] = await Promise.all([
        fetch(apiUrl),
        fetch(previousYearApiUrl)
      ])
      
      if (!reportsResponse.ok) {
        throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
      
      const reportsResult = await reportsResponse.json()
      const reports = reportsResult.success ? reportsResult.data : []
      
      const previousYearResult = previousYearResponse.ok ? await previousYearResponse.json() : { success: false, data: [] }
      const previousYearReports = previousYearResult.success ? previousYearResult.data : []
      
      console.log('â° ä½œæ¥­æ™‚é–“: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨', {
        é¸æŠé‡èœ: selectedVegetable,
        å–å¾—ãƒ¬ãƒãƒ¼ãƒˆæ•°: reports.length,
        å‰å¹´ãƒ¬ãƒãƒ¼ãƒˆæ•°: previousYearReports.length
      })
      
      // æœˆæ¬¡ä½œæ¥­æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
      const monthlyData: WorkHoursData[] = []
      const previousMonthlyData: WorkHoursData[] = []
      
      for (let i = 0; i < responsiveDimensions.monthCount; i++) {
        const currentMonth = addMonths(startMonth, i)
        const monthKey = format(currentMonth, 'yyyy-MM')
        const monthReports = reports.filter((r: any) => 
          r.work_date.startsWith(monthKey)
        )
        
        const workTypes: any = {}
        let monthlyTotalHours = 0
        let monthlyTotalRevenue = 0
        let monthlyTotalCost = 0
        
        // ä½œæ¥­ç¨®åˆ¥ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        Object.keys(WORK_TYPE_COLORS).forEach(workType => {
          const typeReports = monthReports.filter((r: any) => r.work_type === workType)
          
          // work_duration(åˆ†) ã¾ãŸã¯ duration_hours(æ™‚) Ã— worker_count ã§ç·ä½œæ¥­æ™‚é–“ã‚’è¨ˆç®—
          const totalHours = typeReports.reduce((sum: number, r: any) => {
            // work_durationï¼ˆåˆ†ï¼‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°duration_hoursã‚’ä½¿ç”¨
            const minutes = r.work_duration || (r.duration_hours ? r.duration_hours * 60 : 0)
            const workers = r.worker_count || 1
            return sum + (minutes * workers) / 60 // æ™‚é–“å˜ä½ã«å¤‰æ›
          }, 0)
          const totalRevenue = typeReports.reduce((sum: number, r: any) => {
            if (workType === 'harvesting') {
              return sum + ((r.harvest_amount || 0) * (r.expected_price || 0))
            }
            return sum + (r.expected_revenue || 0)
          }, 0)
          
          // ã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã‚‚è€ƒæ…®ï¼‰
          const directCosts = typeReports.reduce((sum: number, r: any) => sum + (r.estimated_cost || (r.duration_hours || 2) * 1000), 0)
          const accountingCosts = typeReports.reduce((sum: number, r: any) => {
            if (r.work_report_accounting && Array.isArray(r.work_report_accounting)) {
              return sum + r.work_report_accounting.reduce((accSum: number, acc: any) => accSum + (acc.amount || 0), 0)
            }
            return sum
          }, 0)
          const totalCost = Math.max(directCosts, accountingCosts)
          
          // åŠ¹ç‡æ€§æŒ‡æ¨™è¨ˆç®—
          const revenuePerHour = totalHours > 0 ? totalRevenue / totalHours : 0
          const costPerHour = totalHours > 0 ? totalCost / totalHours : 0
          const roiPerHour = costPerHour > 0 ? (revenuePerHour - costPerHour) / costPerHour : 0
          const efficiencyScore = Math.min(100, Math.max(0, roiPerHour * 50 + 50))
          
          workTypes[workType] = {
            total_hours: totalHours,
            revenue_per_hour: revenuePerHour,
            cost_per_hour: costPerHour,
            roi_per_hour: roiPerHour,
            efficiency_score: efficiencyScore,
            work_count: typeReports.length,
            details: typeReports.map((r: any) => ({
              id: r.id,
              work_type: r.work_type,
              work_date: r.work_date,
              // work_duration(åˆ†) ã¾ãŸã¯ duration_hours(æ™‚) Ã— worker_count
              duration_hours: (() => {
                const minutes = r.work_duration || (r.duration_hours ? r.duration_hours * 60 : 0)
                const workers = r.worker_count || 1
                return (minutes * workers) / 60 // æ™‚é–“å˜ä½ã«å¤‰æ›
              })(),
              revenue_generated: workType === 'harvesting' ? 
                (r.harvest_amount || 0) * (r.expected_price || 0) : 
                (r.expected_revenue || 0),
              cost_incurred: Math.max(r.estimated_cost || (r.duration_hours || 2) * 1000, 
                (r.work_report_accounting?.reduce((sum: number, acc: any) => sum + (acc.amount || 0), 0)) || 0),
              efficiency_rating: efficiencyScore > 80 ? 'excellent' as const : 
                               efficiencyScore > 60 ? 'good' as const : 
                               efficiencyScore > 40 ? 'average' as const : 'poor' as const,
              description: r.description || r.notes
            }))
          }
          
          monthlyTotalHours += totalHours
          monthlyTotalRevenue += totalRevenue
          monthlyTotalCost += totalCost
        })
        
        const avgEfficiency = Object.values(workTypes).reduce((sum: any, wt: any) => sum + wt.efficiency_score, 0) / Object.keys(workTypes).length
        const aiPredictions = generateAIPredictions(monthlyData, monthReports)
        const benchmarks = generateBenchmarks(monthlyTotalHours)
        
        // ğŸŒ¡ï¸ğŸ’§ Supabaseã‹ã‚‰æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const weatherData = await fetchWeatherData(currentMonth)
        
        monthlyData.push({
          month: format(currentMonth, 'Mæœˆ', { locale: ja }),
          year: currentMonth.getFullYear(),
          month_num: currentMonth.getMonth() + 1,
          work_types: workTypes,
          monthly_total_hours: monthlyTotalHours,
          monthly_avg_efficiency: avgEfficiency,
          monthly_total_revenue: monthlyTotalRevenue,
          monthly_total_cost: monthlyTotalCost,
          weather_data: weatherData,
          ai_predictions: aiPredictions,
          benchmarks: benchmarks
        })
      }
      
      // å‰å¹´ãƒ‡ãƒ¼ã‚¿ã‚‚åŒæ§˜ã«å‡¦ç†ï¼ˆç°¡ç•¥ç‰ˆï¼‰
      for (let i = 0; i < responsiveDimensions.monthCount; i++) {
        const currentMonth = addMonths(startMonth, i)
        const previousMonth = subMonths(currentMonth, 12)
        const monthKey = format(previousMonth, 'yyyy-MM')
        const prevMonthReports = previousYearReports.filter((r: any) => 
          r.work_date.startsWith(monthKey)
        )
        
        const workTypes: any = {}
        let monthlyTotalHours = 0
        
        Object.keys(WORK_TYPE_COLORS).forEach(workType => {
          const typeReports = prevMonthReports.filter((r: any) => r.work_type === workType)
          // work_duration(åˆ†) ã¾ãŸã¯ duration_hours(æ™‚) Ã— worker_count ã§ç·ä½œæ¥­æ™‚é–“ã‚’è¨ˆç®—
          const totalHours = typeReports.reduce((sum: number, r: any) => {
            // work_durationï¼ˆåˆ†ï¼‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°duration_hoursã‚’ä½¿ç”¨
            const minutes = r.work_duration || (r.duration_hours ? r.duration_hours * 60 : 0)
            const workers = r.worker_count || 1
            return sum + (minutes * workers) / 60 // æ™‚é–“å˜ä½ã«å¤‰æ›
          }, 0)
          
          workTypes[workType] = {
            total_hours: totalHours,
            revenue_per_hour: 0,
            cost_per_hour: 0,
            roi_per_hour: 0,
            efficiency_score: 0,
            work_count: typeReports.length,
            details: []
          }
          
          monthlyTotalHours += totalHours
        })
        
        // ğŸŒ¡ï¸ğŸ’§ å‰å¹´ã®æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—
        const previousYearMonth = new Date(currentMonth.getFullYear() - 1, currentMonth.getMonth(), currentMonth.getDate())
        const previousWeatherData = await fetchWeatherData(previousYearMonth)
        
        previousMonthlyData.push({
          month: format(currentMonth, 'Mæœˆ', { locale: ja }),
          year: currentMonth.getFullYear(),
          month_num: currentMonth.getMonth() + 1,
          work_types: workTypes,
          monthly_total_hours: monthlyTotalHours,
          monthly_avg_efficiency: 0,
          monthly_total_revenue: 0,
          monthly_total_cost: 0,
          weather_data: previousWeatherData
        })
      }
      
      setWorkHoursData(monthlyData)
      setPreviousYearData(previousMonthlyData)
      setLastUpdated(new Date())
      console.log('âœ… ä½œæ¥­æ™‚é–“ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†:', monthlyData.length, 'ä»¶')
      
    } catch (error) {
      console.error('âŒ ä½œæ¥­æ™‚é–“ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error)
      setWorkHoursData([])
    } finally {
      setLoading(false)
    }
  }, [companyId, startMonth, selectedVegetable, responsiveDimensions])

  // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒå®Ÿè¡Œ
  React.useEffect(() => {
    if (companyId) {
      fetchWorkHoursData()
    }
  }, [fetchWorkHoursData, companyId])

  // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
  const chartData = useMemo(() => {
    if (!workHoursData || workHoursData.length === 0) return null

    const workTypes = Object.keys(WORK_TYPE_COLORS)
    const datasets = workTypes.map(workType => {
      // Yè»¸ã®å˜ä½ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
      const hoursData = workHoursData.map(d => {
        const hours = d.work_types[workType]?.total_hours || 0
        return hours / yAxisRange.unitDivisor
      })

      return {
        label: `${WORK_TYPE_LABELS[workType as keyof typeof WORK_TYPE_LABELS]}`,
        data: hoursData,
        backgroundColor: WORK_TYPE_COLORS[workType as keyof typeof WORK_TYPE_COLORS],
        borderColor: WORK_TYPE_COLORS[workType as keyof typeof WORK_TYPE_COLORS],
        borderWidth: 1,
        stack: 'hours',
        type: 'bar' as const,
        yAxisID: 'y',
        order: 1
      }
    })
    
    // ğŸŒ¡ï¸ğŸ’§ æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã®ãƒ©ã‚¤ãƒ³è¿½åŠ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã«å¿œã˜ã¦ï¼‰
    if (weatherDisplayOptions.showTemperature) {
      datasets.push({
        label: 'æ°—æ¸© (Â°C)',
        data: workHoursData.map(d => {
          // æœ‰åŠ¹ãªæ°—è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ãƒ—ãƒ­ãƒƒãƒˆ
          return (d.weather_data?.temperature && d.weather_data.temperature > 0) 
            ? d.weather_data.temperature 
            : null
        }),
        borderColor: '#f97316', // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
        backgroundColor: 'rgba(249, 115, 22, 0.1)',
        fill: false,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: '#f97316',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        type: 'line' as const,
        yAxisID: 'y2', // æ°—æ¸©ç”¨ï¼ˆä¸­é–“ä½ç½®ï¼‰
        order: 0,
        spanGaps: false // nullå€¤ã®ç®‡æ‰€ã§ç·šã‚’åˆ‡ã‚‹
      })
    }
    
    if (weatherDisplayOptions.showHumidity) {
      datasets.push({
        label: 'æ¹¿åº¦ (%)',
        data: workHoursData.map(d => {
          // æœ‰åŠ¹ãªæ°—è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ãƒ—ãƒ­ãƒƒãƒˆ
          return (d.weather_data?.humidity && d.weather_data.humidity > 0) 
            ? d.weather_data.humidity 
            : null
        }),
        borderColor: '#3b82f6', // é’è‰²
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: false,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: '#3b82f6',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        type: 'line' as const,
        yAxisID: 'y3', // æ¹¿åº¦ç”¨ï¼ˆæœ€ã‚‚å³å´ï¼‰
        order: 0,
        spanGaps: false // nullå€¤ã®ç®‡æ‰€ã§ç·šã‚’åˆ‡ã‚‹
      })
    }
    
    // ç´¯ç©ä½œæ¥­æ™‚é–“ç·šï¼ˆå³Yè»¸ç”¨ï¼‰
    if (showCumulativeWorkTime) {
      let cumulativeHours = 0
      const cumulativeData = workHoursData.map(d => {
        const monthlyTotal = Object.values(d.work_types).reduce((sum, workType) => sum + (workType.total_hours || 0), 0)
        cumulativeHours += monthlyTotal
        // ç´¯ç©ãƒ‡ãƒ¼ã‚¿ã‚‚å˜ä½å¤‰æ›ã‚’é©ç”¨
        return cumulativeHours / cumulativeYAxisRange.unitDivisor
      })

      datasets.push({
        label: 'ğŸ“Š ç´¯ç©ä½œæ¥­æ™‚é–“',
        data: cumulativeData,
        borderColor: '#059669', // ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰è‰²
        backgroundColor: 'rgba(5, 150, 105, 0.1)',
        borderWidth: 3,
        pointRadius: 5,
        pointBackgroundColor: '#ffffff',
        pointBorderColor: '#059669',
        pointBorderWidth: 2,
        fill: false,
        tension: 0.4,
        type: 'line' as const,
        yAxisID: 'y1', // ç´¯ç©ä½œæ¥­æ™‚é–“ç”¨ï¼ˆæœ€ã‚‚å·¦å´ï¼‰
        order: -1, // æœ€å‰é¢ã«è¡¨ç¤º
        pointHoverRadius: 7,
        pointHoverBorderWidth: 3,
      })
    }
    
    const monthLabels = workHoursData.map(d => d.month)
    
    return {
      labels: monthLabels,
      datasets: [...datasets]
    }
  }, [workHoursData, weatherDisplayOptions, showCumulativeWorkTime, yAxisRange, cumulativeYAxisRange])

  // ä½œæ¥­æ™‚é–“å‰²åˆã®è¨ˆç®—
  const workTimePercentages = useMemo(() => {
    if (!workHoursData || workHoursData.length === 0) return {}

    const workTypes = Object.keys(WORK_TYPE_COLORS)
    const totalHoursByType: { [key: string]: number } = {}
    let totalAllHours = 0

    // æœŸé–“å…¨ä½“ã®ä½œæ¥­æ™‚é–“ã‚’é›†è¨ˆ
    workHoursData.forEach(monthData => {
      Object.entries(monthData.work_types).forEach(([workType, workData]) => {
        const hours = workData?.total_hours || 0
        totalHoursByType[workType] = (totalHoursByType[workType] || 0) + hours
        totalAllHours += hours
      })
    })

    // å‰²åˆã‚’è¨ˆç®—
    const percentages: { [key: string]: number } = {}
    workTypes.forEach(workType => {
      const hours = totalHoursByType[workType] || 0
      percentages[workType] = totalAllHours > 0 ? Math.round((hours / totalAllHours) * 100) : 0
    })

    return { percentages, totalHours: totalAllHours }
  }, [workHoursData])

  // Yè»¸ç¯„å›²ã®è¨ˆç®—
  const yAxisRange = useMemo(() =>
    calculateYAxisRange(workHoursData), [workHoursData, calculateYAxisRange]
  )

  // ç´¯ç©ä½œæ¥­æ™‚é–“ç”¨Yè»¸ç¯„å›²ã®è¨ˆç®—ï¼ˆå¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆï¼‰
  const cumulativeYAxisRange = useMemo(() => {
    if (!workHoursData || workHoursData.length === 0 || !showCumulativeWorkTime) {
      return {
        min: 0,
        max: 100,
        stepSize: 20,
        tickCount: 6,
        unit: 'hours',
        unitDivisor: 1,
        unitLabel: 'æ™‚é–“'
      }
    }

    // ç´¯ç©ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—
    let cumulativeHours = 0
    const cumulativeValues = workHoursData.map(d => {
      const monthlyTotal = Object.values(d.work_types).reduce((sum: number, wt: any) =>
        sum + (wt?.total_hours || 0), 0
      )
      cumulativeHours += monthlyTotal
      return cumulativeHours
    })

    const rawMax = Math.max(...cumulativeValues, 10)
    let targetMax = rawMax * 1.2

    // å˜ä½ã®è‡ªå‹•é¸æŠï¼ˆå·¦è»¸ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    let unit = 'hours'
    let unitDivisor = 1
    let unitLabel = 'æ™‚é–“'

    if (targetMax >= 50000) {
      unit = 'man'
      unitDivisor = 10000
      unitLabel = 'ä¸‡æ™‚é–“'
      targetMax = targetMax / 10000
    } else if (targetMax >= 5000) {
      unit = 'sen'
      unitDivisor = 1000
      unitLabel = 'åƒæ™‚é–“'
      targetMax = targetMax / 1000
    }

    // å·¦è»¸ã¨å¿…ãšåŒã˜ãƒ¡ãƒ¢ãƒªæ•°ã«ã™ã‚‹
    const targetTickCount = yAxisRange.tickCount || 6

    // å˜ä½å¤‰æ›å¾Œã®æœ€é©ãªã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚º
    const niceSteps = [
      0.1, 0.2, 0.25, 0.5,
      1, 2, 2.5, 5,
      10, 20, 25, 50,
      100, 200, 250, 500,
      1000, 2000, 2500, 5000,
      10000
    ]

    let bestStep = 1
    for (const step of niceSteps) {
      const candidateMax = step * (targetTickCount - 1)
      if (candidateMax >= targetMax) {
        bestStep = step
        break
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
    if (bestStep * (targetTickCount - 1) < targetMax) {
      bestStep = Math.ceil(targetMax / (targetTickCount - 1))
    }

    const adjustedMax = bestStep * (targetTickCount - 1)

    return {
      min: 0,
      max: adjustedMax,
      stepSize: bestStep,
      tickCount: targetTickCount,
      unit,
      unitDivisor,
      unitLabel
    }
  }, [workHoursData, yAxisRange, showCumulativeWorkTime])

  // ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢å¯¸æ³•ã®æ›´æ–°
  const updateChartDimensions = useCallback(() => {
    if (chartRef.current) {
      const chart = chartRef.current
      const chartArea = chart.chartArea
      const meta = chart.getDatasetMeta(0)
      
      if (chartArea && meta && meta.data.length > 0) {
        const firstBar = meta.data[0]
        const lastBar = meta.data[meta.data.length - 1]
        
        if (firstBar && lastBar) {
          const actualLeft = firstBar.x - (firstBar.width || 0) / 2
          const actualRight = lastBar.x + (lastBar.width || 0) / 2
          const actualWidth = actualRight - actualLeft
          
          setChartDimensions({
            left: Math.round(actualLeft),
            right: Math.round(chart.width - actualRight),
            width: Math.round(actualWidth)
          })
        }
      }
    }
  }, [])

  useEffect(() => {
    if (chartRef.current && workHoursData.length > 0) {
      setTimeout(updateChartDimensions, 100)
    }
  }, [workHoursData, updateChartDimensions])

  // è¤‡æ•°å³è»¸è¡¨ç¤ºç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆç„¡åŠ¹åŒ– - è»¸ä½ç½®ã¯ afterFit ã§åˆ¶å¾¡ï¼‰
  const multipleRightAxisPlugin = {
    id: 'multipleRightAxis',
    beforeDraw: (chart: any) => {
      // è»¸ã®å‹•çš„ãªä½ç½®èª¿æ•´ã¯è¡Œã‚ãªã„
      // å…¨ã¦ã®è»¸ä½ç½®ã¯ afterFit é–¢æ•°ã§å›ºå®šçš„ã«åˆ¶å¾¡ã•ã‚Œã‚‹
    }
  }

  // ãƒãƒ£ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³
  const chartOptions: ChartOptions<'bar'> = useMemo(() => {
    // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹Yè»¸ã®æ•°ã‚’è¨ˆç®—
    const visibleAxesCount =
      (showCumulativeWorkTime ? 1 : 0) +
      (weatherDisplayOptions.showTemperature ? 1 : 0) +
      (weatherDisplayOptions.showHumidity ? 1 : 0);

    // Yè»¸ã®æ•°ã«å¿œã˜ã¦å³å´ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‹•çš„ã«èª¿æ•´
    const rightPadding = visibleAxesCount === 0 ? 0 :
                        visibleAxesCount === 1 ? 0 :
                        visibleAxesCount === 2 ? 10 :
                        20; // 3è»¸ã®å ´åˆ

    return ({
    responsive: true,
    maintainAspectRatio: false,
    layout: {
      padding: {
        left: 0,
        // Yè»¸ã®æ•°ã«å¿œã˜ã¦å‹•çš„ã«èª¿æ•´
        right: rightPadding,
        top: 0,
        bottom: 0
      },
      autoPadding: false // è‡ªå‹•ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ã‚’ç„¡åŠ¹åŒ–
    },
    interaction: {
      mode: 'index',
      intersect: false
    },
    onClick: (event: ChartEvent, elements: InteractionItem[]) => {
      if (elements.length > 0 && chartRef.current) {
        const elementIndex = elements[0].index
        const selectedData = workHoursData[elementIndex]
        if (selectedData) {
          setSelectedMonth(selectedData)
          setDrilldownOpen(true)
        }
      }
    },
    scales: {
      x: {
        type: 'category',
        stacked: true,
        grid: {
          display: false,
          drawBorder: true,
          drawOnChartArea: false,
          drawTicks: false
        },
        ticks: {
          display: false,
          maxRotation: 0,
          minRotation: 0
        },
        border: {
          display: true,
          color: '#e5e7eb',
          width: 1
        },
        offset: true,
        barPercentage: responsiveDimensions.barPercentage,
        categoryPercentage: responsiveDimensions.categoryPercentage,
        bounds: 'ticks',
        afterFit: function(scale: any) {
          scale.paddingBottom = 60
          // å·¦å³ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¯å›ºå®šï¼ˆå‹•çš„èª¿æ•´ã—ãªã„ï¼‰
          scale.paddingLeft = 0
          scale.paddingRight = 0
        }
      },
      y: {
        type: 'linear',
        display: true,
        position: 'left',
        stacked: true,
        min: yAxisRange.min,
        max: yAxisRange.max,
        grid: {
          color: '#e5e7eb',
          lineWidth: 1,
          drawTicks: false
        },
        border: {
          color: '#374151',
          width: 2 // å›ºå®šå¹…
        },
        ticks: {
          stepSize: yAxisRange.stepSize, // 11å€‹ã®ç›®ç››ã‚Šã«å›ºå®š
          color: '#1f2937',
          font: {
            size: Math.max(12, responsiveDimensions.fontSize + 1), // å›ºå®šã‚µã‚¤ã‚º
            weight: '600',
            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
          },
          padding: 8, // å›ºå®šãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
          callback: function(value) {
            const numValue = value as number
            // 1000ä»¥ä¸Šã¯åƒhè¡¨è¨˜ã€æœªæº€ã¯é€šå¸¸è¡¨è¨˜
            if (numValue >= 1000) {
              return `${(numValue / 1000).toFixed(1)}åƒh`
            }
            return `${numValue.toFixed(1)}h`
          }
        },
        // å·¦å´Yè»¸ã¯å¸¸ã«å›ºå®šä½ç½®
        beginAtZero: false,
        offset: false // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ç„¡åŠ¹åŒ–
      },
      // ğŸ“Š ç´¯ç©ä½œæ¥­æ™‚é–“è»¸ï¼ˆæœ€ã‚‚å·¦å´ï¼‰
      ...(showCumulativeWorkTime ? {
        y1: {
          type: 'linear' as const,
          display: true,
          position: 'right' as const,
          min: cumulativeYAxisRange.min,
          max: cumulativeYAxisRange.max,
          grid: {
            drawOnChartArea: false,
          },
          border: {
            color: '#059669', // ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰è‰²
            width: 2
          },
          ticks: {
            stepSize: cumulativeYAxisRange.stepSize,
            color: '#059669',
            font: {
              size: Math.max(12, responsiveDimensions.fontSize + 1),
              weight: '600' as const,
              family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
            },
            padding: 1,
            callback: function(value: any) {
              const numValue = value as number
              // 1000ä»¥ä¸Šã¯åƒhè¡¨è¨˜ã€æœªæº€ã¯é€šå¸¸è¡¨è¨˜
              if (numValue >= 1000) {
                return `${(numValue / 1000).toFixed(1)}åƒh`
              }
              return `${numValue}h`
            }
          },
          title: {
            display: true,
            text: `ç´¯ç©ä½œæ¥­æ™‚é–“ (${cumulativeYAxisRange.unitLabel})`,
            color: '#059669',
            font: {
              size: 13,
              weight: 'bold' as const
            },
            padding: 4
          },
          // ç´¯ç©ä½œæ¥­æ™‚é–“è»¸ã¯æœ€ã‚‚å·¦å´ï¼ˆã‚°ãƒ©ãƒ•ã«æ¥ã—ã¦é…ç½®ï¼‰
          offset: false
        }
      } : {}),
      // ğŸŒ¡ï¸ æ°—æ¸©è»¸ï¼ˆä¸­é–“ä½ç½®ï¼‰
      ...(weatherDisplayOptions.showTemperature ? {
        y2: {
          type: 'linear' as const,
          display: true,
          position: 'right' as const,
          min: -10,  // å®Ÿç”¨çš„ãªç¯„å›²ã«èª¿æ•´
          max: 40,   // æ—¥æœ¬ã®æ°—å€™ã«é©ã—ãŸç¯„å›²
          grid: {
            drawOnChartArea: false,
          },
          border: {
            color: '#f97316',
            width: 2
          },
          ticks: {
            stepSize: 10,  // 10åº¦åˆ»ã¿ã§6å€‹ã®ç›®ç››ã‚Šï¼ˆ-10, 0, 10, 20, 30, 40ï¼‰
            color: '#f97316',
            font: {
              size: Math.max(12, responsiveDimensions.fontSize + 1),
              weight: '600' as const,
              family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
            },
            padding: 1,
            callback: function(value: any) {
              return `${value}Â°C`
            }
          },
          title: {
            display: false
          },
          // æ°—æ¸©è»¸ã¯ä¸­é–“ä½ç½®ã«é…ç½®
          offset: true
        }
      } : {}),
      // ğŸ’§ æ¹¿åº¦è»¸ï¼ˆæœ€ã‚‚å³å´ï¼‰
      ...(weatherDisplayOptions.showHumidity ? {
        y3: {
          type: 'linear' as const,
          display: true,
          position: 'right' as const,
          min: 0,   // 0%ã‹ã‚‰
          max: 100,  // 100%ã¾ã§
          grid: {
            drawOnChartArea: false,
          },
          border: {
            color: '#3b82f6',
            width: 2
          },
          ticks: {
            stepSize: 20,  // 20%åˆ»ã¿ã§6å€‹ã®ç›®ç››ã‚Šï¼ˆ0, 20, 40, 60, 80, 100ï¼‰
            color: '#3b82f6',
            font: {
              size: Math.max(12, responsiveDimensions.fontSize + 1),
              weight: '600' as const,
              family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
            },
            padding: 1,
            callback: function(value: any) {
              return `${value}%`
            }
          },
          title: {
            display: false
          },
          // æ¹¿åº¦è»¸ã¯æœ€ã‚‚å³å´ã«é…ç½®
          offset: true
        }
      } : {})
    },
    plugins: {
      legend: {
        display: false
      },
      multipleRightAxis: true,
      tooltip: {
        backgroundColor: '#ffffff',
        titleColor: '#1f2937',
        bodyColor: '#374151',
        borderColor: '#d1d5db',
        borderWidth: 1,
        cornerRadius: 8,
        padding: 12,
        displayColors: true, // è‰²ä»˜ããƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
        titleFont: {
          size: 14,
          weight: '600'
        },
        bodyFont: {
          size: 12,
          weight: '400'
        },
        interaction: {
          mode: 'point' as const, // ãƒã‚¤ãƒ³ãƒˆã”ã¨ã«å€‹åˆ¥è¡¨ç¤º
          intersect: false // ã‚«ãƒ¼ã‚½ãƒ«ãŒè¿‘ãã«ã‚ã‚Œã°è¡¨ç¤º
        },
        callbacks: {
          title: (context) => {
            const dataIndex = context[0].dataIndex
            const data = workHoursData[dataIndex]
            return `${data.year}å¹´${data.month} - ä½œæ¥­æ™‚é–“åˆ†æ`
          },
          label: (context) => {
            const value = context.raw as number
            const datasetLabel = context.dataset.label || ''
            const datasetType = context.dataset.type || 'bar'
            
            // ç·šã‚°ãƒ©ãƒ•ï¼ˆç´¯ç©ãƒ‡ãƒ¼ã‚¿ï¼‰ã®å ´åˆ
            if (datasetType === 'line') {
              if (datasetLabel.includes('ç´¯ç©')) {
                return `${datasetLabel}: ${value.toLocaleString()}æ™‚é–“`
              } else if (datasetLabel.includes('æ°—æ¸©')) {
                return `${datasetLabel}: ${value}Â°C`
              } else if (datasetLabel.includes('æ¹¿åº¦')) {
                return `${datasetLabel}: ${value}%`
              }
            }
            
            // æ£’ã‚°ãƒ©ãƒ•ï¼ˆä½œæ¥­ç¨®åˆ¥ãƒ‡ãƒ¼ã‚¿ï¼‰ã®å ´åˆ
            const workType = datasetLabel.replace('ä½œæ¥­', '')
            if (value > 0) {
              return `${datasetLabel}: ${value.toLocaleString()}æ™‚é–“`
            } else if (value === 0) {
              return `${datasetLabel}: å®Ÿæ–½ãªã—`
            }
            return `${datasetLabel}: ${value.toLocaleString()}æ™‚é–“`
          },
          afterBody: (context) => {
            const dataIndex = context[0].dataIndex
            const data = workHoursData[dataIndex]
            const result = []
            
            // æœˆæ¬¡ã‚µãƒãƒªãƒ¼
            result.push('', 'ğŸ“Š ã€æœˆæ¬¡ã‚µãƒãƒªãƒ¼ã€‘')
            result.push(`ğŸ’ª ç·ä½œæ¥­æ™‚é–“: ${data.monthly_total_hours.toLocaleString()}æ™‚é–“`)
            result.push(`ğŸ’° ç·åç›Š: Â¥${data.monthly_total_revenue.toLocaleString()}`)
            result.push(`ğŸ’¸ ç·ã‚³ã‚¹ãƒˆ: Â¥${data.monthly_total_cost.toLocaleString()}`)
            result.push(`ğŸ“ˆ å¹³å‡åŠ¹ç‡: ${(data.monthly_avg_efficiency * 100).toFixed(1)}%`)
            
            // ä½œæ¥­ç¨®åˆ¥ã®è©³ç´°ï¼ˆä¸Šä½3ä»¶ï¼‰
            const workTypesArray = Object.entries(data.work_types)
              .filter(([_, details]) => details.total_hours > 0)
              .sort((a, b) => b[1].total_hours - a[1].total_hours)
              .slice(0, 3)
            
            if (workTypesArray.length > 0) {
              result.push('', 'ğŸ” ã€ä½œæ¥­ç¨®åˆ¥TOP3ã€‘')
              workTypesArray.forEach(([type, details]) => {
                const workTypeLabel = WORK_TYPE_LABELS[type as keyof typeof WORK_TYPE_LABELS] || type
                result.push(`â€¢ ${workTypeLabel}: ${details.total_hours}h (${details.work_count}å›)`)
                if (details.roi_per_hour > 0) {
                  result.push(`  ROI: Â¥${Math.round(details.roi_per_hour)}/h`)
                }
              })
            }
            
            // AIäºˆæ¸¬æƒ…å ±
            if (data.ai_predictions) {
              result.push('', 'ğŸ¤– ã€AIäºˆæ¸¬åˆ†æã€‘')
              result.push(`äºˆæ¸¬ä½œæ¥­æ™‚é–“: ${data.ai_predictions.predicted_hours}æ™‚é–“`)
              
              const trendEmoji = data.ai_predictions.efficiency_trend === 'improving' ? 'ğŸ“ˆ' :
                                data.ai_predictions.efficiency_trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸'
              const trendText = data.ai_predictions.efficiency_trend === 'improving' ? 'æ”¹å–„å‚¾å‘' :
                               data.ai_predictions.efficiency_trend === 'declining' ? 'ä½ä¸‹å‚¾å‘' : 'æ¨ªã°ã„'
              result.push(`åŠ¹ç‡ãƒˆãƒ¬ãƒ³ãƒ‰: ${trendEmoji} ${trendText}`)
              result.push(`æœ€é©åŒ–ã‚¹ã‚³ã‚¢: ${(data.ai_predictions.optimization_score * 100).toFixed(0)}%`)
              
              // AIææ¡ˆï¼ˆæœ€åˆã®1ã¤ã®ã¿è¡¨ç¤ºï¼‰
              if (data.ai_predictions.suggestions && data.ai_predictions.suggestions.length > 0) {
                result.push(`ğŸ’¡ ${data.ai_predictions.suggestions[0]}`)
              }
            }
            
            // æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
            if (data.benchmarks) {
              result.push('', 'ğŸ“Š ã€æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã€‘')
              result.push(`æ¥­ç•Œå¹³å‡: ${data.benchmarks.industry_average_hours}æ™‚é–“`)
              result.push(`ãƒˆãƒƒãƒ—ä¼æ¥­: ${data.benchmarks.top_performers_hours}æ™‚é–“`)
              result.push(`åŠ¹ç‡é †ä½: ä¸Šä½${data.benchmarks.efficiency_percentile}%`)
            }
            
            // æ°—è±¡æƒ…å ±
            if (data.weather_data && (weatherDisplayOptions.showTemperature || weatherDisplayOptions.showHumidity)) {
              result.push('', 'ğŸŒ¡ï¸ğŸ’§ ã€æ°—è±¡æ¡ä»¶ã€‘')
              if (weatherDisplayOptions.showTemperature) {
                result.push(`å¹³å‡æ°—æ¸©: ${data.weather_data.temperature}Â°C`)
                result.push(`æ°—æ¸©ç¯„å›²: ${data.weather_data.temperature_range.min}Â°Cï½${data.weather_data.temperature_range.max}Â°C`)
              }
              if (weatherDisplayOptions.showHumidity) {
                result.push(`å¹³å‡æ¹¿åº¦: ${data.weather_data.humidity}%`)
                result.push(`æ¹¿åº¦ç¯„å›²: ${data.weather_data.humidity_range.min}%ï½${data.weather_data.humidity_range.max}%`)
              }
            }
            
            // ç´¯ç©ä½œæ¥­æ™‚é–“ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆ
            const hoveredDataset = context[0].dataset
            if (hoveredDataset && hoveredDataset.type === 'line' && hoveredDataset.label?.includes('ç´¯ç©')) {
              result.push('', 'ğŸ“ˆ ã€ç´¯ç©åˆ†æã€‘')
              const cumulativeHours = hoveredDataset.data[dataIndex] as number
              result.push(`ç´¯ç©ä½œæ¥­æ™‚é–“: ${cumulativeHours.toLocaleString()}æ™‚é–“`)
              
              // å‰æœˆæ¯”è¼ƒ
              if (dataIndex > 0) {
                const prevCumulative = hoveredDataset.data[dataIndex - 1] as number
                const monthlyIncrease = cumulativeHours - prevCumulative
                const growthRate = prevCumulative > 0 ? ((monthlyIncrease / prevCumulative) * 100).toFixed(1) : '0.0'
                result.push(`å‰æœˆæ¯”: +${monthlyIncrease.toLocaleString()}æ™‚é–“ (${growthRate}%å¢—)`)
              }
            }
            
            result.push('', 'ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°åˆ†æã‚’è¡¨ç¤º')
            
            return result
          }
        }
      }
    },
    animation: {
      duration: 600,
      easing: 'easeOutQuart',
      onComplete: function(animation) {
        setTimeout(updateChartDimensions, 50)
      }
    },
    onResize: function(chart, size) {
      setTimeout(updateChartDimensions, 50)
    }
  })}, [yAxisRange, workHoursData, updateChartDimensions, responsiveDimensions, weatherDisplayOptions, showCumulativeWorkTime])

  // å¹´æœˆé¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleYearMonthChange = () => {
    const newDate = new Date(selectedYear, selectedMonthNum - 1, 1)
    setStartMonth(newDate)
    setYearMonthPickerOpen(false)
  }

  // å¹´æœˆé¸æŠã®åˆæœŸåŒ–
  React.useEffect(() => {
    setSelectedYear(startMonth.getFullYear())
    setSelectedMonthNum(startMonth.getMonth() + 1)
  }, [startMonth])

  // åˆè¨ˆå€¤ã®è¨ˆç®—
  const periodTotals = useMemo(() => {
    if (!workHoursData || workHoursData.length === 0) return {}
    
    const totals: { [workType: string]: number } = {}
    Object.keys(WORK_TYPE_COLORS).forEach(workType => {
      totals[workType] = workHoursData.reduce((sum, d) => 
        sum + (d.work_types[workType]?.total_hours || 0), 0
      )
    })
    return totals
  }, [workHoursData])

  if (loading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>AIäºˆæ¸¬ä½œæ¥­æ™‚é–“åˆ†æ</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="h-[600px] flex items-center justify-center">
            <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-indigo-500"></div>
          </div>
        </CardContent>
      </Card>
    )
  }

  return (
    <>
      <Card>
        <CardHeader className="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm">
                <Clock className="w-6 h-6" />
              </div>
              <div>
                <CardTitle className="text-xl font-bold">
                  ğŸ¤– AIäºˆæ¸¬ä½œæ¥­æ™‚é–“åˆ†æ
                </CardTitle>
                <p className="text-green-100 text-sm">
                  AI-Powered Work Hours & ROI Analysis
                </p>
              </div>
            </div>
            <div className="text-right">
              <div className="text-xs text-green-100 uppercase tracking-wider">AgriFinance Pro</div>
              <div className="text-sm font-medium">åŠ´åƒåŠ¹ç‡æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ </div>
            </div>
          </div>
        </CardHeader>
        
        <CardContent className="p-6">
          {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
          <div className="mb-6 p-4 bg-gradient-to-r from-gray-50 to-indigo-50 rounded-lg border">
            <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
              <div className="flex items-center gap-3 flex-wrap">
                {/* è¡¨ç¤ºæœŸé–“é¸æŠ */}
                <div className="flex items-center gap-1 bg-white rounded-lg p-1 shadow-sm">
                  {[1, 2, 3].map((period) => (
                    <Button
                      key={period}
                      variant={displayPeriod === period ? 'default' : 'ghost'}
                      size="sm"
                      onClick={() => setDisplayPeriod(period as 1 | 2 | 3)}
                      className={`px-3 h-7 text-xs ${
                        displayPeriod === period 
                          ? 'bg-indigo-600 text-white shadow-sm' 
                          : 'text-gray-600 hover:bg-gray-50 hover:text-gray-800'
                      }`}
                    >
                      {period}å¹´
                    </Button>
                  ))}
                </div>
                
                {/* AIæ´å¯Ÿãƒˆã‚°ãƒ« */}
                <Button
                  variant={showAIInsights ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setShowAIInsights(!showAIInsights)}
                  className={showAIInsights ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'text-gray-600'}
                >
                  <Zap className="w-4 h-4 mr-1" />
                  AIæ´å¯Ÿ
                </Button>

                {/* ç´¯ç©ä½œæ¥­æ™‚é–“ç·šãƒˆã‚°ãƒ« */}
                <Button
                  variant={showCumulativeWorkTime ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setShowCumulativeWorkTime(!showCumulativeWorkTime)}
                  className={showCumulativeWorkTime ? 'bg-emerald-600 hover:bg-emerald-700 text-white' : 'text-gray-600'}
                >
                  ğŸ“Š ç´¯ç©æ™‚é–“ç·š
                </Button>
                
                {/* å‰å¹´æ¯”è¼ƒãƒˆã‚°ãƒ« */}
                <Button
                  variant={showComparison ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setShowComparison(!showComparison)}
                  disabled={previousYearData.length === 0}
                  className={showComparison ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'text-gray-600'}
                >
                  ğŸ“ˆ å‰å¹´æ¯”è¼ƒ
                </Button>
                
                {/* ğŸŒ¡ï¸ğŸ’§ æ°—è±¡ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒˆã‚°ãƒ« */}
                <div className="flex items-center gap-2 bg-white rounded-lg p-1 shadow-sm">
                  <Button
                    variant={weatherDisplayOptions.showTemperature ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setWeatherDisplayOptions(prev => ({
                      ...prev,
                      showTemperature: !prev.showTemperature
                    }))}
                    className={`px-3 h-7 text-xs ${
                      weatherDisplayOptions.showTemperature 
                        ? 'bg-orange-500 text-white shadow-sm' 
                        : 'text-orange-600 hover:bg-orange-50'
                    }`}
                  >
                    ğŸŒ¡ï¸ æ°—æ¸©
                  </Button>
                  <Button
                    variant={weatherDisplayOptions.showHumidity ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setWeatherDisplayOptions(prev => ({
                      ...prev,
                      showHumidity: !prev.showHumidity
                    }))}
                    className={`px-3 h-7 text-xs ${
                      weatherDisplayOptions.showHumidity 
                        ? 'bg-blue-500 text-white shadow-sm' 
                        : 'text-blue-600 hover:bg-blue-50'
                    }`}
                  >
                    ğŸ’§ æ¹¿åº¦
                  </Button>
                </div>
                
                {/* å¹´æœˆé¸æŠ - é‡‘èÃ—è¾²æ¥­ãƒ‡ã‚¶ã‚¤ãƒ³ */}
                <Popover open={yearMonthPickerOpen} onOpenChange={setYearMonthPickerOpen} modal={true}>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="flex items-center gap-2 min-w-[160px] bg-gradient-to-r from-emerald-50 to-green-50 border-emerald-200 hover:from-emerald-100 hover:to-green-100 transition-all duration-200 shadow-sm"
                    >
                      <div className="flex items-center gap-2">
                        <div className="w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center">
                          <CalendarIcon className="w-3 h-3 text-white" />
                        </div>
                        <div className="flex flex-col items-start">
                          <span className="font-bold text-emerald-800">{format(startMonth, 'yyyyå¹´', { locale: ja })}</span>
                          <span className="text-xs text-emerald-600">{format(startMonth, 'Mæœˆé–‹å§‹', { locale: ja })}</span>
                        </div>
                        <Sprout className="w-4 h-4 text-emerald-500 ml-auto" />
                      </div>
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-96 p-0 bg-white border-2 border-emerald-200 shadow-2xl z-50 rounded-xl overflow-hidden">
                    <div className="p-5 border-b border-emerald-100 bg-gradient-to-r from-emerald-600 to-green-600 text-white">
                      <h4 className="font-bold text-lg flex items-center gap-2">
                        <Sprout className="w-5 h-5" />
                        æ ½åŸ¹æœŸé–“è¨­å®š
                      </h4>
                      <p className="text-sm text-emerald-100 mt-1">åˆ†æé–‹å§‹å¹´æœˆã‚’é¸æŠï¼ˆ{displayPeriod}å¹´é–“åˆ†æï¼‰</p>
                    </div>
                    
                    <div className="p-4 space-y-4">
                      {/* å¹´é¸æŠ */}
                      <div className="space-y-2">
                        <label className="text-sm font-medium text-gray-700 flex items-center gap-2">
                          ğŸ“… å¹´
                          <span className="text-xs text-gray-500">ï¼ˆéå»30å¹´ã‹ã‚‰é¸æŠï¼‰</span>
                        </label>
                        <div className="h-32 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 p-2">
                          <div className="grid grid-cols-3 gap-2">
                            {Array.from({length: 30}, (_, i) => new Date().getFullYear() - i).map(year => (
                              <Button
                                key={year}
                                variant={selectedYear === year ? 'default' : 'outline'}
                                size="sm"
                                onClick={() => setSelectedYear(year)}
                                className={`text-xs h-8 ${
                                  selectedYear === year 
                                    ? 'bg-indigo-600 text-white shadow-md scale-105' 
                                    : 'hover:bg-indigo-50 bg-white'
                                } transition-all duration-200`}
                              >
                                {year}
                              </Button>
                            ))}
                          </div>
                        </div>
                      </div>
                      
                      {/* æœˆé¸æŠ */}
                      <div className="space-y-2">
                        <label className="text-sm font-medium text-gray-700">æœˆ</label>
                        <div className="grid grid-cols-4 gap-2">
                          {Array.from({length: 12}, (_, i) => i + 1).map(month => (
                            <Button
                              key={month}
                              variant={selectedMonthNum === month ? 'default' : 'outline'}
                              size="sm"
                              onClick={() => setSelectedMonthNum(month)}
                              className={`text-xs ${selectedMonthNum === month ? 'bg-indigo-600 text-white' : 'hover:bg-indigo-50'}`}
                            >
                              {month}æœˆ
                            </Button>
                          ))}
                        </div>
                      </div>
                      
                      {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
                      <div className="flex gap-2 pt-2">
                        <Button
                          onClick={handleYearMonthChange}
                          className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white"
                          size="sm"
                        >
                          âœ… æœŸé–“ã‚’é©ç”¨
                        </Button>
                        <Button
                          onClick={() => setYearMonthPickerOpen(false)}
                          variant="outline"
                          size="sm"
                          className="px-4"
                        >
                          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </Button>
                      </div>
                    </div>
                  </PopoverContent>
                </Popover>
              </div>
              
              <div className="text-xs text-gray-500">
                æœ€çµ‚æ›´æ–°: {lastUpdated.toLocaleString('ja-JP', { 
                  month: 'short', 
                  day: 'numeric', 
                  hour: '2-digit', 
                  minute: '2-digit' 
                })}
              </div>
            </div>
          </div>
          
          {/* ã‚°ãƒ©ãƒ• */}
          <div ref={containerRef} className="h-[600px] relative overflow-visible">
            {chartData && (
              <div className="relative z-10" style={{ height: '580px' }}>
                <Bar 
                  ref={chartRef}
                  data={chartData} 
                  options={{
                    ...chartOptions,
                    maintainAspectRatio: false,
                    aspectRatio: undefined
                  }}
                  plugins={[multipleRightAxisPlugin]}
                />
              </div>
            )}
            
            {/* ã‚«ã‚¹ã‚¿ãƒ Xè»¸ãƒ©ãƒ™ãƒ« */}
            {chartDimensions.width > 0 && (
              <div 
                className="absolute bottom-0 pointer-events-none z-0" 
                style={{ 
                  left: `${chartDimensions.left}px`,
                  right: `${chartDimensions.right}px`,
                  width: `${chartDimensions.width}px`
                }}
              >
                {/* æœˆè¡¨ç¤ºå±¤ */}
                <div className="relative bg-white border-t border-gray-300" style={{ height: '40px' }}>
                  {workHoursData.map((data, index) => {
                    const chart = chartRef.current
                    let barLeftX = chartDimensions.width / workHoursData.length * index
                    let barWidth = chartDimensions.width / workHoursData.length
                    
                    if (chart) {
                      const meta = chart.getDatasetMeta(0)
                      if (meta && meta.data[index]) {
                        const bar = meta.data[index]
                        barLeftX = (bar.x - (bar.width || 0) / 2) - chartDimensions.left
                        barWidth = bar.width || barWidth
                      }
                    }
                    
                    return (
                      <div
                        key={`month-${index}`}
                        className="absolute text-center text-sm font-medium text-gray-800 py-2 flex items-center justify-center"
                        style={{ 
                          left: `${barLeftX}px`,
                          width: `${barWidth}px`,
                          top: '0px',
                          height: '40px'
                        }}
                      >
                        {data.month}
                      </div>
                    )
                  })}
                </div>
                
                {/* å¹´è¡¨ç¤ºå±¤ */}
                <div className="relative border-t-2 border-gray-400 bg-gray-100" style={{ height: '40px' }}>
                  {(() => {
                    const yearGroups = []
                    let currentYear = null
                    let yearStartIndex = 0
                    
                    workHoursData.forEach((data, index) => {
                      if (data.year !== currentYear) {
                        if (currentYear !== null) {
                          yearGroups.push({ 
                            year: currentYear, 
                            startIndex: yearStartIndex, 
                            endIndex: index - 1 
                          })
                        }
                        currentYear = data.year
                        yearStartIndex = index
                      }
                    })
                    
                    if (currentYear !== null) {
                      yearGroups.push({ 
                        year: currentYear, 
                        startIndex: yearStartIndex, 
                        endIndex: workHoursData.length - 1 
                      })
                    }
                    
                    return yearGroups.map((yearData) => {
                      const chart = chartRef.current
                      let startX = 0
                      let endX = chartDimensions.width
                      
                      if (chart) {
                        const meta = chart.getDatasetMeta(0)
                        if (meta && meta.data.length > 0) {
                          const startBar = meta.data[yearData.startIndex]
                          const endBar = meta.data[yearData.endIndex]
                          
                          if (startBar && endBar) {
                            startX = (startBar.x - (startBar.width || 0) / 2) - chartDimensions.left
                            endX = (endBar.x + (endBar.width || 0) / 2) - chartDimensions.left
                          }
                        }
                      }
                      
                      const yearWidth = endX - startX
                      
                      return (
                        <div
                          key={`year-${yearData.year}`}
                          className="absolute text-center text-sm font-bold text-gray-900 py-2 bg-gray-50 flex items-center justify-center border-r border-gray-400"
                          style={{ 
                            left: `${startX}px`,
                            width: `${yearWidth}px`,
                            top: '0px',
                            height: '40px'
                          }}
                        >
                          {yearData.year}å¹´
                        </div>
                      )
                    })
                  })()}
                </div>
              </div>
            )}
          </div>
          
          {/* ä½œæ¥­ç¨®åˆ¥å‡¡ä¾‹ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ */}
          <Collapsible open={isWorkTypeTotalsOpen} onOpenChange={setIsWorkTypeTotalsOpen}>
            <div className="mt-6 p-4 bg-gradient-to-r from-gray-50 to-indigo-50 border border-gray-200 rounded-lg">
              <CollapsibleTrigger className="w-full">
                <h4 className="font-medium text-gray-800 mb-3 flex items-center gap-2 cursor-pointer hover:text-gray-600">
                  <ChevronRight
                    className={`w-4 h-4 transition-transform duration-200 ${isWorkTypeTotalsOpen ? 'rotate-90' : ''}`}
                  />
                  â° ä½œæ¥­ç¨®åˆ¥ãƒ»æœŸé–“åˆè¨ˆæ™‚é–“
                  <span className="text-xs text-gray-500 font-normal">
                    ï¼ˆåˆè¨ˆ: {workTimePercentages.totalHours?.toFixed(1) || 0}æ™‚é–“ï¼‰
                  </span>
                  <span className="text-xs text-gray-500 ml-auto">
                    {isWorkTypeTotalsOpen ? 'é–‰ã˜ã‚‹' : 'å±•é–‹ã™ã‚‹'}
                  </span>
                </h4>
              </CollapsibleTrigger>
              <CollapsibleContent>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {Object.entries(WORK_TYPE_LABELS).map(([workType, label]) => (
                    <div key={workType} className="flex items-center gap-2 p-2 bg-white rounded border shadow-sm">
                      <div
                        className="w-4 h-4 rounded flex-shrink-0"
                        style={{ backgroundColor: WORK_TYPE_COLORS[workType as keyof typeof WORK_TYPE_COLORS] }}
                      />
                      <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-gray-700 truncate">{label}</div>
                        <div className="text-xs text-gray-500 space-y-1">
                          <div>{(periodTotals[workType] || 0).toFixed(1)}æ™‚é–“</div>
                          <div className="font-semibold text-indigo-600">
                            {workTimePercentages.percentages?.[workType] || 0}%
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </CollapsibleContent>
            </div>
          </Collapsible>
          
          {/* AIæ´å¯Ÿãƒ‘ãƒãƒ« */}
          {showAIInsights && workHoursData.length > 0 && (
            <div className="mt-4 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg">
              <h4 className="font-medium text-purple-800 mb-3 flex items-center gap-2">
                <Zap className="w-4 h-4" />
                ğŸ¤– AIåˆ†ææ´å¯Ÿ
              </h4>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                {workHoursData[workHoursData.length - 1]?.ai_predictions && (
                  <>
                    <div className="bg-white border border-purple-200 rounded-lg p-3">
                      <div className="font-semibold text-purple-800 mb-1">åŠ¹ç‡æ€§ãƒˆãƒ¬ãƒ³ãƒ‰</div>
                      <div className={`text-lg font-bold mb-2 ${
                        workHoursData[workHoursData.length - 1].ai_predictions!.efficiency_trend === 'improving' ? 'text-green-600' :
                        workHoursData[workHoursData.length - 1].ai_predictions!.efficiency_trend === 'declining' ? 'text-red-600' :
                        'text-blue-600'
                      }`}>
                        {workHoursData[workHoursData.length - 1].ai_predictions!.efficiency_trend === 'improving' ? 'ğŸ“ˆ æ”¹å–„ä¸­' :
                         workHoursData[workHoursData.length - 1].ai_predictions!.efficiency_trend === 'declining' ? 'ğŸ“‰ ä½ä¸‹ä¸­' :
                         'â¡ï¸ å®‰å®š'}
                      </div>
                      <div className="text-xs text-gray-600">
                        æœ€é©åŒ–ã‚¹ã‚³ã‚¢: {workHoursData[workHoursData.length - 1].ai_predictions!.optimization_score}%
                      </div>
                    </div>
                    
                    <div className="bg-white border border-purple-200 rounded-lg p-3">
                      <div className="font-semibold text-purple-800 mb-1">æ¥æœˆäºˆæ¸¬</div>
                      <div className="text-lg font-bold text-blue-600 mb-2">
                        {workHoursData[workHoursData.length - 1].ai_predictions!.predicted_hours.toFixed(0)}æ™‚é–“
                      </div>
                      <div className="text-xs text-gray-600">
                        å‰æœˆæ¯”: {((workHoursData[workHoursData.length - 1].ai_predictions!.predicted_hours / workHoursData[workHoursData.length - 1].monthly_total_hours - 1) * 100).toFixed(1)}%
                      </div>
                    </div>
                    
                    {workHoursData[workHoursData.length - 1]?.benchmarks && (
                      <div className="bg-white border border-purple-200 rounded-lg p-3">
                        <div className="font-semibold text-purple-800 mb-1">æ¥­ç•Œæ¯”è¼ƒ</div>
                        <div className="text-lg font-bold text-indigo-600 mb-2">
                          {workHoursData[workHoursData.length - 1].benchmarks!.efficiency_percentile}%ile
                        </div>
                        <div className="text-xs text-gray-600">
                          {workHoursData[workHoursData.length - 1].benchmarks!.efficiency_percentile >= 75 ? 'ä¸Šä½å››åˆ†ä½' :
                           workHoursData[workHoursData.length - 1].benchmarks!.efficiency_percentile >= 50 ? 'å¹³å‡ä»¥ä¸Š' :
                           'æ”¹å–„ä½™åœ°ã‚ã‚Š'}
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
              
              {/* AIææ¡ˆ */}
              {workHoursData[workHoursData.length - 1]?.ai_predictions?.suggestions && workHoursData[workHoursData.length - 1].ai_predictions!.suggestions.length > 0 && (
                <div className="mt-4 p-3 bg-white border border-purple-200 rounded-lg">
                  <div className="font-semibold text-purple-800 mb-2 flex items-center gap-2">
                    <Target className="w-4 h-4" />
                    AIæœ€é©åŒ–ææ¡ˆ
                  </div>
                  <ul className="text-sm text-gray-700 space-y-1">
                    {workHoursData[workHoursData.length - 1].ai_predictions!.suggestions.map((suggestion, index) => (
                      <li key={index} className="flex items-start gap-2">
                        <span className="text-purple-500 mt-1">â€¢</span>
                        {suggestion}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
          
          <div className="mt-4 text-xs text-gray-500 text-center">
            ğŸ’¡ å„æœˆã®æ£’ã‚°ãƒ©ãƒ•ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°åˆ†æã‚’è¡¨ç¤ºã§ãã¾ã™
            {showAIInsights && <span className="ml-2">ï½œğŸ¤– AIäºˆæ¸¬ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹</span>}
          </div>
        </CardContent>
      </Card>

      {/* è©³ç´°åˆ†æãƒ€ã‚¤ã‚¢ãƒ­ã‚° */}
      <Dialog open={drilldownOpen} onOpenChange={setDrilldownOpen} modal={true}>
        <LargeDialogContent 
          width="1200px" 
          height="900px"
          title={selectedMonth ? `${selectedMonth.year}å¹´${selectedMonth.month}ã®ä½œæ¥­æ™‚é–“è©³ç´°åˆ†æ` : "ä½œæ¥­æ™‚é–“è©³ç´°åˆ†æ"}
        >
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 -mx-6 -mt-6 mb-6 px-6 py-4 rounded-t-lg">
            <div className="flex items-center justify-between text-white">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm">
                  <Clock className="w-5 h-5" />
                </div>
                <div>
                  <h2 className="text-xl font-bold tracking-tight">
                    {selectedMonth && `${selectedMonth.year}å¹´${selectedMonth.month}`}
                  </h2>
                  <p className="text-indigo-100 text-sm">AIäºˆæ¸¬ä½œæ¥­æ™‚é–“è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</p>
                </div>
              </div>
              <div className="text-right">
                <div className="text-xs text-indigo-100 uppercase tracking-wider">AgriTech Pro</div>
                <div className="text-lg font-semibold">åŠ´åƒåŠ¹ç‡æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ </div>
              </div>
            </div>
          </div>
          
          {selectedMonth && (
            <div className="space-y-6">
              {/* ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ */}
              <div className="bg-gradient-to-r from-gray-50 to-indigo-50 border border-gray-200 rounded-lg p-5">
                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                  âš¡ ä½œæ¥­åŠ¹ç‡ã‚µãƒãƒªãƒ¼
                  <div className="ml-auto px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-medium rounded-full">
                    åŠ´åƒç”Ÿç”£æ€§æŒ‡æ¨™
                  </div>
                </h3>
                <div className="grid grid-cols-4 gap-4">
                  {/* ç·ä½œæ¥­æ™‚é–“ */}
                  <div className="bg-white border border-indigo-200 rounded-lg p-4 shadow-sm">
                    <div className="flex items-center justify-between mb-2">
                      <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                        <Clock className="w-5 h-5 text-indigo-600" />
                      </div>
                      <div className="text-xs text-indigo-600 font-medium px-2 py-1 bg-indigo-50 rounded">
                        ä½œæ¥­æ™‚é–“
                      </div>
                    </div>
                    <div className="text-2xl font-bold text-indigo-700 mb-1">
                      {selectedMonth.monthly_total_hours.toFixed(1)}h
                    </div>
                    <div className="text-sm text-gray-600">ç·ä½œæ¥­æ™‚é–“ | Total Hours</div>
                    <div className="text-xs text-gray-500 mt-1">å…¨ä½œæ¥­ã®åˆè¨ˆæ™‚é–“</div>
                  </div>
                  
                  {/* å¹³å‡åŠ¹ç‡ */}
                  <div className="bg-white border border-green-200 rounded-lg p-4 shadow-sm">
                    <div className="flex items-center justify-between mb-2">
                      <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <Target className="w-5 h-5 text-green-600" />
                      </div>
                      <div className="text-xs text-green-600 font-medium px-2 py-1 bg-green-50 rounded">
                        åŠ¹ç‡æ€§
                      </div>
                    </div>
                    <div className="text-2xl font-bold text-green-700 mb-1">
                      {selectedMonth.monthly_avg_efficiency.toFixed(1)}
                    </div>
                    <div className="text-sm text-gray-600">å¹³å‡åŠ¹ç‡ã‚¹ã‚³ã‚¢ | Efficiency</div>
                    <div className="text-xs text-gray-500 mt-1">100ç‚¹æº€ç‚¹ã®åŠ¹ç‡æŒ‡æ¨™</div>
                  </div>
                  
                  {/* æ™‚é–“ã‚ãŸã‚Šåç›Š */}
                  <div className="bg-white border border-purple-200 rounded-lg p-4 shadow-sm">
                    <div className="flex items-center justify-between mb-2">
                      <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                        <TrendingUp className="w-5 h-5 text-purple-600" />
                      </div>
                      <div className="text-xs text-purple-600 font-medium px-2 py-1 bg-purple-50 rounded">
                        æ™‚çµ¦åŠ¹ç‡
                      </div>
                    </div>
                    <div className="text-2xl font-bold text-purple-700 mb-1">
                      Â¥{selectedMonth.monthly_total_hours > 0 ? 
                        Math.round(selectedMonth.monthly_total_revenue / selectedMonth.monthly_total_hours) : 0}
                    </div>
                    <div className="text-sm text-gray-600">æ™‚é–“å½“ãŸã‚Šåç›Š | Revenue/h</div>
                    <div className="text-xs text-gray-500 mt-1">1æ™‚é–“ã®ä½œæ¥­ã§å¾—ã‚‰ã‚Œã‚‹åç›Š</div>
                  </div>
                  
                  {/* ROI */}
                  <div className="bg-white border border-yellow-200 rounded-lg p-4 shadow-sm">
                    <div className="flex items-center justify-between mb-2">
                      <div className="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                        <Award className="w-5 h-5 text-yellow-600" />
                      </div>
                      <div className="text-xs text-yellow-600 font-medium px-2 py-1 bg-yellow-50 rounded">
                        æŠ•è³‡åŠ¹ç‡
                      </div>
                    </div>
                    <div className="text-2xl font-bold text-yellow-700 mb-1">
                      {selectedMonth.monthly_total_cost > 0 ? 
                        (((selectedMonth.monthly_total_revenue - selectedMonth.monthly_total_cost) / selectedMonth.monthly_total_cost) * 100).toFixed(1) : 0}%
                    </div>
                    <div className="text-sm text-gray-600">æŠ•è³‡åç›Šç‡ | ROI</div>
                    <div className="text-xs text-gray-500 mt-1">ã‚³ã‚¹ãƒˆã«å¯¾ã™ã‚‹åˆ©ç›Šç‡</div>
                  </div>
                </div>
              </div>

              {/* ä½œæ¥­ç¨®åˆ¥è©³ç´°åˆ†æ */}
              <div className="bg-white border border-gray-200 rounded-lg shadow-sm">
                <div className="bg-gradient-to-r from-slate-50 to-indigo-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                  <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                    ğŸ› ï¸ ä½œæ¥­ç¨®åˆ¥åŠ¹ç‡åˆ†æ
                    <div className="ml-auto px-3 py-1 bg-indigo-100 text-indigo-700 text-xs font-medium rounded-full">
                      Work Type Efficiency Analysis
                    </div>
                  </h3>
                  <p className="text-sm text-gray-600 mt-1">å„ä½œæ¥­ã«ãŠã‘ã‚‹æ™‚é–“åŠ¹ç‡ã¨ROIåˆ†æ</p>
                </div>
                
                <div className="p-6">
                  <div className="space-y-4">
                    {Object.entries(selectedMonth.work_types)
                      .filter(([_, data]) => data.total_hours > 0)
                      .sort(([,a], [,b]) => b.total_hours - a.total_hours)
                      .map(([workType, data], index) => (
                        <div key={workType} className="bg-gradient-to-r from-gray-50 to-indigo-50 border border-gray-200 rounded-lg p-4">
                          {/* ä½œæ¥­ç¨®åˆ¥ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-3">
                              <div 
                                className="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm shadow-sm"
                                style={{ backgroundColor: WORK_TYPE_COLORS[workType as keyof typeof WORK_TYPE_COLORS] }}
                              >
                                {(index + 1).toString().padStart(2, '0')}
                              </div>
                              <div>
                                <h4 className="font-bold text-gray-800">
                                  {WORK_TYPE_LABELS[workType as keyof typeof WORK_TYPE_LABELS]}
                                </h4>
                                <p className="text-xs text-gray-500">ä½œæ¥­å›æ•°: {data.work_count}å›</p>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${
                                data.efficiency_score >= 80 ? 'bg-green-100 text-green-800' :
                                data.efficiency_score >= 60 ? 'bg-blue-100 text-blue-800' :
                                data.efficiency_score >= 40 ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                åŠ¹ç‡: {data.efficiency_score.toFixed(1)}ç‚¹
                              </div>
                            </div>
                          </div>
                          
                          {/* åŠ¹ç‡æŒ‡æ¨™ */}
                          <div className="grid grid-cols-3 gap-4 mb-4">
                            <div className="bg-white border border-gray-200 rounded-lg p-3 text-center">
                              <div className="text-lg font-bold text-indigo-700">{data.total_hours.toFixed(1)}h</div>
                              <div className="text-xs text-gray-600">ç·ä½œæ¥­æ™‚é–“</div>
                            </div>
                            
                            <div className="bg-white border border-gray-200 rounded-lg p-3 text-center">
                              <div className="text-lg font-bold text-green-700">Â¥{Math.round(data.revenue_per_hour)}</div>
                              <div className="text-xs text-gray-600">æ™‚é–“å½“ãŸã‚Šåç›Š</div>
                            </div>
                            
                            <div className="bg-white border border-gray-200 rounded-lg p-3 text-center">
                              <div className={`text-lg font-bold ${data.roi_per_hour > 0 ? 'text-blue-700' : 'text-red-700'}`}>
                                {(data.roi_per_hour * 100).toFixed(1)}%
                              </div>
                              <div className="text-xs text-gray-600">æ™‚é–“å½“ãŸã‚ŠROI</div>
                            </div>
                          </div>
                          
                          {/* ä½œæ¥­è©³ç´° */}
                          {data.details.length > 0 && (
                            <div className="mt-4 pt-4 border-t border-gray-300">
                              <div className="flex items-center justify-between mb-3">
                                <h5 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                                  ğŸ“‹ ä½œæ¥­å®Ÿç¸¾è©³ç´°
                                  <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    {data.details.length}ä»¶
                                  </span>
                                </h5>
                              </div>
                              <div className="max-h-40 overflow-y-auto space-y-2 bg-white border border-gray-200 rounded-lg p-3">
                                {data.details.slice(0, 5).map((detail, detailIndex) => (
                                  <div key={detail.id} className="bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs">
                                    <div className="flex justify-between items-start mb-2">
                                      <div className="font-medium text-gray-800 flex items-center gap-2">
                                        <span className={`w-5 h-5 rounded text-center text-xs leading-5 ${
                                          detail.efficiency_rating === 'excellent' ? 'bg-green-100 text-green-600' :
                                          detail.efficiency_rating === 'good' ? 'bg-blue-100 text-blue-600' :
                                          detail.efficiency_rating === 'average' ? 'bg-yellow-100 text-yellow-600' :
                                          'bg-red-100 text-red-600'
                                        }`}>
                                          {detailIndex + 1}
                                        </span>
                                        {new Date(detail.work_date).toLocaleDateString('ja-JP')}
                                      </div>
                                      <div className="text-right">
                                        <div className="font-bold text-indigo-700 text-sm">{detail.duration_hours.toFixed(1)}h</div>
                                        <div className="text-xs text-gray-500">
                                          ROI: {detail.cost_incurred > 0 ? 
                                            (((detail.revenue_generated - detail.cost_incurred) / detail.cost_incurred) * 100).toFixed(1) : 
                                            0}%
                                        </div>
                                      </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2 text-gray-600">
                                      <div className="flex items-center gap-1">
                                        <span className="text-green-600">ğŸ’°</span>
                                        åç›Š: Â¥{Math.round(detail.revenue_generated)}
                                      </div>
                                      <div className="flex items-center gap-1">
                                        <span className="text-red-600">ğŸ’¸</span>
                                        ã‚³ã‚¹ãƒˆ: Â¥{Math.round(detail.cost_incurred)}
                                      </div>
                                    </div>
                                    
                                    {detail.description && (
                                      <div className="mt-2 text-gray-500 text-xs italic border-l-2 border-gray-300 pl-2">
                                        ğŸ’­ {detail.description}
                                      </div>
                                    )}
                                  </div>
                                ))}
                                {data.details.length > 5 && (
                                  <div className="text-center text-gray-500 text-xs py-2">
                                    ä»– {data.details.length - 5} ä»¶ã®ä½œæ¥­å®Ÿç¸¾ãŒã‚ã‚Šã¾ã™
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */}
          <div className="flex justify-center pt-6 mt-6 border-t border-gray-200 bg-gradient-to-t from-gray-50 to-white -mx-6 -mb-6 px-6 pb-6 rounded-b-lg">
            <DialogPrimitive.Close asChild>
              <Button 
                variant="outline" 
                className="flex items-center gap-2 px-8 py-3 text-gray-700 border-gray-300 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-medium"
              >
                <X className="w-4 h-4" />
                åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
              </Button>
            </DialogPrimitive.Close>
          </div>
        </LargeDialogContent>
      </Dialog>
    </>
  )
}